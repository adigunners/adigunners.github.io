<!doctype html>
<!--
  index.html
  -----------------
  Purpose: The main landing page for the IIM Mumbai Fantasy League site.

  High-level structure:
    - <head>: SEO meta tags, fonts, icons, and a small helper `escapeHTML`
    - <body>: header with countdown + registration UI, leaderboard preview,
              winner preview and registration instructions
    - <script>: client-side logic to load `data/league_stats.json`, next-deadline
                (for the countdown), winners/leaderboard preview, and QA/test tooling

  Data sources in `data/` used by this page:
    - data/league_stats.json
    - data/next_deadline.json
    - data/winner_stats.json
    - data/test_winner_stats.json

  URL query params supported:
    - test=true        -> UI shows test-only elements and loads demo data
    - data={auto|test|live} -> control which winner dataset to load
    - debug=1          -> verbose console logging
    - phase={pre|season|auto} -> force view/redirect behaviour
    - clockOffset=<ms> -> client-side clock offset to help debugging timezone issues

  Contributor notes:
    - The JavaScript is written to be runnable in a static environment. For local
      testing, serve the repo root with a simple static server (e.g. python3 -m http.server).
    - The QA panel is visible only in test/admin modes and helps inspect cached state.
-->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Helper to escape HTML special characters -->
    <script>
      function escapeHTML(str) {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }
    </script>

    <!-- SEO Meta Tags -->
    <title>IIM Mumbai Fantasy League - Season 2025-26 | Join Now</title>
    <meta
      name="description"
      content="Join the IIM Mumbai Fantasy Premier League 2025-26! ‚Çπ3,000 entry fee with weekly, monthly & season prizes. Register now to compete with fellow MBA students."
    />
    <meta
      name="keywords"
      content="IIM Mumbai, Fantasy Premier League, FPL, MBA students, fantasy football, EPL, prize money"
    />
    <meta name="author" content="IIM Mumbai Fantasy League Committee" />

    <!-- SEO Control & Indexing -->
    <meta
      name="robots"
      content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"
    />
    <meta name="googlebot" content="index, follow" />
    <link rel="canonical" href="https://adigunners.github.io/" />

    <!-- Additional SEO Meta Tags -->
    <meta name="language" content="English" />
    <meta name="revisit-after" content="7 days" />
    <meta name="distribution" content="web" />
    <meta name="rating" content="general" />
    <meta name="theme-color" content="#37003c" />
    <meta name="msapplication-TileColor" content="#37003c" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://adigunners.github.io/" />
    <meta property="og:title" content="IIM Mumbai Fantasy League - Season 2025-26 | Join Now" />
    <meta
      property="og:description"
      content="Join the IIM Mumbai Fantasy Premier League 2025-26! ‚Çπ3,000 entry fee with weekly, monthly & season prizes. Register now to compete with fellow MBA students."
    />
    <meta property="og:image" content="https://adigunners.github.io/assets/fpl-og-image.jpg" />
    <meta property="og:image:alt" content="IIM Mumbai Fantasy Premier League 2025-26" />
    <meta property="og:site_name" content="IIM Mumbai Fantasy League" />
    <meta property="og:locale" content="en_US" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@IIMMumbai" />
    <meta name="twitter:creator" content="@addygunners" />
    <meta name="twitter:url" content="https://adigunners.github.io/" />
    <meta name="twitter:title" content="IIM Mumbai Fantasy League - Season 2025-26 | Join Now" />
    <meta
      name="twitter:description"
      content="Join the IIM Mumbai Fantasy Premier League 2025-26! ‚Çπ3,000 entry fee with weekly, monthly & season prizes. Register now to compete with fellow MBA students."
    />
    <meta name="twitter:image" content="https://adigunners.github.io/assets/fpl-og-image.jpg" />
    <meta name="twitter:image:alt" content="IIM Mumbai Fantasy Premier League 2025-26" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/images/favicon.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

    <!-- Performance Optimizations -->
    <link rel="dns-prefetch" href="//fantasy.premierleague.com" />
    <link rel="preconnect" href="https://fantasy.premierleague.com" crossorigin />
    <!-- theme-color meta is optional; removed to avoid cross-browser support warning -->

    <!-- Preload self-hosted fonts for fast paint -->
    <link
      rel="preload"
      as="font"
      type="font/woff2"
      href="assets/fonts/poppins/poppins-latin-400.woff2"
      crossorigin
    />
    <link
      rel="preload"
      as="font"
      type="font/woff2"
      href="assets/fonts/poppins/poppins-latin-600.woff2"
      crossorigin
    />
    <link
      rel="preload"
      as="font"
      type="font/woff2"
      href="assets/fonts/poppins/poppins-latin-700.woff2"
      crossorigin
    />

    <!-- CSS: Consolidated foundation (variables, fonts, base, spacing) -->
    <link rel="stylesheet" href="css/styles.css?v=1.0.5" />

    <!-- Critical CSS: minimal above-the-fold styles for stable first paint -->
    <style>
      /* Essential variables inlined for critical path */
      :root {
        --primary-color: #37003c;
        --heading-color: #37003c;
        --background-color: #f8f9fa;
        --page-backdrop: #f8f9fa;
        --card-background: #fff;
        --text-color: #212529;
        --border-radius: 8px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --radius-lg: 8px;
        --container-max-width: 1200px;
        --spacing-md: 16px;
        --box-gap: 16px;
        --box-min-width: 200px;
        --box-padding: 20px;
        /* safe-area for consistent header height on first paint */
        --safe-top: env(safe-area-inset-top, 0px);
      }

      .site-header {
        position: sticky;
        top: 0;
        z-index: 1000;
        background-color: var(--page-backdrop);
        padding-top: calc(8px + var(--safe-top));
        padding-bottom: 0;
        margin-bottom: var(--spacing-lg);
        /* Progressive auto-hide via CSS variables set by JS */
        transform: translateY(calc(-1 * var(--header-offset, 0px)));
        will-change: transform;
      }
      .header-inner {
        width: 100%;
        margin: 0 auto;
        padding: 0;
        /* Optional fade as header hides */
        opacity: var(--header-opacity, 1);
      }
      header {
        background: linear-gradient(135deg, var(--primary-color), var(--heading-color));
        color: #fff;
        text-align: center;
        padding: clamp(12px, 4svh, 50px) clamp(8px, 2vw, 20px);
        border-radius: var(--border-radius);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: clamp(8px, 2svh, 20px);
        flex-wrap: wrap;
        position: relative;
        width: 100%;
        min-height: clamp(56px, 12svh, 120px);
        background-clip: padding-box;
      }
      @media (max-width: 600px) {
        .site-header {
          padding-top: calc(4px + var(--safe-top));
          margin-bottom: 12px;
        }
        header {
          padding: 10px 10px;
          min-height: 56px;
          gap: 8px;
        }
        .countdown-clock {
          max-width: 200px;
          padding: 8px 10px;
        }
        .container {
          margin-top: 4px;
        }
      }
      .header-main {
        flex: 1 1 auto;
        min-width: 0;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      header h1 {
        margin: 0;
        font-size: clamp(1rem, 4vw, 2rem);
        font-weight: 700;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      header p {
        margin: 4px 0 0;
        font-size: clamp(0.8rem, 3vw, 1rem);
        opacity: 0.9;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .countdown-clock {
        max-width: 300px;
        border-radius: var(--border-radius);
        padding: 12px 16px;
        border: 2px solid transparent;
      }
      .countdown-clock.is-hidden {
        display: block !important;
        visibility: hidden;
      }
      /* Shared critical container styling to avoid post-paint jumps */
      .section-card,
      .section__card {
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-lg);
        border-radius: var(--radius-lg);
        background-color: var(--card-background);
      }
      /* Stats row minimal critical styles (defer sizes to components.css) */
      .stats-row,
      .stats__row {
        display: flex;
        flex-wrap: wrap;
        gap: var(--box-gap);
        justify-content: center;
        margin-bottom: var(--spacing-lg);
        width: 100%;
      }
      .stat-box,
      .stats__box {
        flex: 1 1 0;
        min-width: var(--box-min-width);
        padding: var(--box-padding);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        text-align: center;
        border-radius: var(--radius-lg);
        background: var(--card-background);
        min-height: 120px; /* keep stable initial paint */
      }
    </style>

    <!-- 2. Layout: Core layout and spacing (merged into styles.css) -->

    <!-- 3. Components: now in styles.css -->

    <!-- 4. Page-specific: Individual page styles -->
    <!-- 4. Page-specific: now in styles.css -->
    <!-- 5. Enhancements & QA: now in styles.css -->

    <!-- 5. Enhancements: Special features and animations -->
    <!-- countdown enhancements merged into styles.css -->

    <!-- 6. Responsive: merged into styles.css -->

    <!-- 7. Fallback CSS consolidated into styles.css for better maintainability -->

    <!-- Load test/admin wrappers only when needed to reduce main bundle size -->
    <script>
      (function () {
        var qp = new URLSearchParams(location.search);
        if (qp.get('test') === 'true' || qp.get('admin') === 'true') {
          var s = document.createElement('script');
          s.src = 'js/test-admin-wrappers.js?v=1.0.5';
          s.defer = true;
          document.head.appendChild(s);
        }
      })();
    </script>

    <!-- External Resource Integrity Check & Fallback Script -->
    <script>
      (function () {
        'use strict';

        // Check if external resources loaded successfully
        function checkExternalResources() {
          try {
            const fallbackCSS = document.getElementById('fallback-css');
            let needsFallback = false;

            // Check if Google Fonts loaded
            try {
              const testPoppins = document.createElement('div');
              testPoppins.style.fontFamily = 'Poppins, serif';
              testPoppins.style.position = 'absolute';
              testPoppins.style.left = '-9999px';
              testPoppins.innerHTML = 'test';
              document.body.appendChild(testPoppins);

              const poppinsStyle = window.getComputedStyle(testPoppins);
              if (poppinsStyle.fontFamily.indexOf('Poppins') === -1) {
                needsFallback = true;
                document.body.classList.add('poppins-fallback');
                console.warn('Google Fonts failed to load, using system fonts');
              }
              document.body.removeChild(testPoppins);
            } catch (e) {
              console.warn('Google Fonts check failed:', e);
              needsFallback = true;
              document.body.classList.add('poppins-fallback');
            }

            // Enable fallback CSS if needed
            if (needsFallback && fallbackCSS) {
              fallbackCSS.disabled = false;
              document.body.classList.add('external-resources-failed');
              console.info('Fallback CSS enabled due to external resource failures');
            }

            // Report successful loading if no fallbacks needed
            if (!needsFallback) {
              console.info('All external resources loaded successfully');
            }
          } catch (e) {
            console.error('External resource check failed completely:', e);
            // Enable fallback as safety measure
            const fallbackCSS = document.getElementById('fallback-css');
            if (fallbackCSS) {
              fallbackCSS.disabled = false;
              document.body.classList.add('external-resources-failed');
            }
          }
        }

        // Check resources after page load
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function () {
            setTimeout(checkExternalResources, 100);
          });
        } else {
          setTimeout(checkExternalResources, 100);
        }

        // Also check after all resources loaded
        window.addEventListener('load', function () {
          setTimeout(checkExternalResources, 200);
        });
      })();
    </script>

    <!-- Error Handling System (loaded with other modules below) -->

    <!-- Structured Data (JSON-LD) for Rich Search Results -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@graph": [
          {
            "@type": "Organization",
            "@id": "https://adigunners.github.io/#organization",
            "name": "IIM Mumbai Fantasy League Committee",
            "url": "https://adigunners.github.io/",
            "sameAs": ["https://www.iimb.ac.in/"],
            "logo": {
              "@type": "ImageObject",
              "url": "https://adigunners.github.io/assets/fpl-og-image.jpg",
              "width": 1200,
              "height": 630
            }
          },
          {
            "@type": "WebSite",
            "@id": "https://adigunners.github.io/#website",
            "url": "https://adigunners.github.io/",
            "name": "IIM Mumbai Fantasy League",
            "description": "Join the IIM Mumbai Fantasy Premier League 2025-26! ‚Çπ3,000 entry fee with weekly, monthly & season prizes. Register now to compete with fellow MBA students.",
            "publisher": {
              "@id": "https://adigunners.github.io/#organization"
            },
            "potentialAction": [
              {
                "@type": "SearchAction",
                "target": {
                  "@type": "EntryPoint",
                  "urlTemplate": "https://adigunners.github.io/?search={search_term_string}"
                },
                "query-input": "required name=search_term_string"
              }
            ]
          },
          {
            "@type": "WebPage",
            "@id": "https://adigunners.github.io/#webpage",
            "url": "https://adigunners.github.io/",
            "name": "IIM Mumbai Fantasy League - Season 2025-26 | Join Now",
            "isPartOf": {
              "@id": "https://adigunners.github.io/#website"
            },
            "about": {
              "@id": "https://adigunners.github.io/#organization"
            },
            "description": "Join the IIM Mumbai Fantasy Premier League 2025-26! ‚Çπ3,000 entry fee with weekly, monthly & season prizes. Register now to compete with fellow MBA students.",
            "breadcrumb": {
              "@id": "https://adigunners.github.io/#breadcrumb"
            },
            "inLanguage": "en-US",
            "potentialAction": [
              {
                "@type": "ReadAction",
                "target": ["https://adigunners.github.io/"]
              }
            ]
          },
          {
            "@type": "BreadcrumbList",
            "@id": "https://adigunners.github.io/#breadcrumb",
            "itemListElement": [
              {
                "@type": "ListItem",
                "position": 1,
                "name": "Home",
                "item": "https://adigunners.github.io/"
              }
            ]
          },
          {
            "@type": "Event",
            "@id": "https://adigunners.github.io/#event",
            "name": "IIM Mumbai Fantasy Premier League 2025-26",
            "description": "Annual fantasy football competition for IIM Mumbai students with weekly, monthly, and season-end prizes totaling significant prize money.",
            "startDate": "2025-08-01",
            "endDate": "2026-05-31",
            "eventStatus": "https://schema.org/EventScheduled",
            "eventAttendanceMode": "https://schema.org/OnlineEventAttendanceMode",
            "location": {
              "@type": "VirtualLocation",
              "url": "https://adigunners.github.io/"
            },
            "organizer": {
              "@id": "https://adigunners.github.io/#organization"
            },
            "offers": {
              "@type": "Offer",
              "url": "https://forms.gle/xXRXCMKNtNMcGxsr9",
              "price": "3000",
              "priceCurrency": "INR",
              "availability": "https://schema.org/InStock",
              "validFrom": "2025-08-01"
            },
            "image": "https://adigunners.github.io/assets/fpl-og-image.jpg"
          },
          {
            "@type": "SportsOrganization",
            "@id": "https://adigunners.github.io/#sportsorg",
            "name": "IIM Mumbai Fantasy League",
            "sport": "Fantasy Football",
            "url": "https://adigunners.github.io/",
            "description": "Premier fantasy football league for IIM Mumbai MBA students featuring weekly prizes, monthly rewards, and season championship.",
            "foundingDate": "2024",
            "memberOf": {
              "@type": "EducationalOrganization",
              "name": "Indian Institute of Management Mumbai"
            }
          }
        ]
      }
    </script>
  </head>
  <body>
    <!-- Skip Navigation Links for Accessibility -->
    <nav class="skip-navigation" aria-label="Skip navigation">
      <a href="#main-content" class="skip-link">Skip to main content</a>
      <a href="#league-statistics" class="skip-link">Skip to league statistics</a>
      <a href="#registration" class="skip-link">Skip to registration</a>
      <a href="#winners-section" class="skip-link">Skip to winners</a>
      <a href="#leaderboard-section" class="skip-link">Skip to leaderboard</a>
      <a href="#prize-structure" class="skip-link">Skip to prize structure</a>
    </nav>

    <div class="container">
      <!-- FIX: mobile sticky header opacity ‚Äî sticky backplate wrapper -->
      <div class="site-header">
        <div class="header-inner">
          <header>
            <!-- Main Content -->
            <div class="header-main">
              <h1><span class="section-emoji">‚öΩ</span>IIM Mumbai Fantasy League</h1>
              <p>Season 2025-26 - Registration Open</p>
            </div>

            <!-- Digital Countdown Clock -->
            <div id="countdown-clock" class="countdown-clock" aria-live="polite">
              <div class="countdown-label" id="countdown-label">Time until GW1 deadline</div>
              <div class="countdown-time">
                <span class="countdown-unit">
                  <span id="countdown-days">00</span>
                  <span class="countdown-unit-label">D</span>
                </span>
                <span class="countdown-separator">:</span>
                <span class="countdown-unit">
                  <span id="countdown-hours">00</span>
                  <span class="countdown-unit-label">H</span>
                </span>
                <span class="countdown-separator">:</span>
                <span class="countdown-unit">
                  <span id="countdown-minutes">00</span>
                  <span class="countdown-unit-label">M</span>
                </span>
              </div>
            </div>
          </header>
        </div>
      </div>

      <main id="main-content" tabindex="-1">
        <!-- LEAGUE STATISTICS -->
        <section
          id="league-statistics"
          class="league-stats section-card section__card section__card--stats"
          aria-labelledby="stats-heading"
          tabindex="-1"
        >
          <h2 class="section-heading section__heading" id="stats-heading">
            <span class="heading-main section__heading-main"
              ><span class="section-emoji section__emoji">üßÆ</span>Mini-League Snapshot</span
            >
          </h2>
          <div class="stats-row stats__row">
            <!-- PLAYER COUNT BOX -->
            <article class="stat-box stats__box" aria-labelledby="player-count-title">
              <div
                class="stat-box__icon stats__icon"
                title="Fantasy Football Managers"
                aria-hidden="true"
              >
                üë•
              </div>
              <div id="player-count" class="stat-box__number stats__number" aria-live="polite">
                --
              </div>
              <h3 id="player-count-title" class="stat-box__title stats__title">
                Total Registered Players
              </h3>
            </article>
            <!-- POT AMOUNT BOX -->
            <article class="stat-box stats__box" aria-labelledby="pot-amount-title">
              <div class="stat-box__icon stats__icon" title="Prize Money Pot" aria-hidden="true">
                üí∞
              </div>
              <div id="pot-amount" class="stat-box__number stats__number" aria-live="polite">
                --
              </div>
              <h3 id="pot-amount-title" class="stat-box__title stats__title">Total Pot Amount</h3>
            </article>
          </div>
        </section>

        <!-- REGISTRATION SECTION (Before Season) -->
        <section
          id="registration"
          class="season-section section-card section__card section__card--season section__card--pre-season pre-season"
          tabindex="-1"
        >
          <h2>Join the League!</h2>
          <p>
            Ready to prove your FPL skills? Registration is now open. Click the button below to fill
            out the form and join the action.
          </p>
          <a
            href="https://forms.gle/xXRXCMKNtNMcGxsr9"
            class="cta-button"
            target="_blank"
            rel="noopener"
            >Register Now</a
          >
        </section>

        <!-- WINNER SCORECARD SECTION (During Season) -->
        <section
          id="winners-section"
          class="winner-scorecard season-section section-card section__card section__card--winner section__card--season section__card--during-season during-season is-hidden"
          tabindex="-1"
        >
          <h2 class="section-heading section__heading" id="winners-heading">
            <span class="heading-main section__heading-main"
              ><span class="section-emoji section__emoji">üéÜ</span>Top Earners So Far</span
            >
            <span class="heading-subtitle section__heading-subtitle" id="winners-after-gw"
              >Loading‚Ä¶</span
            >
          </h2>
          <p>Leading players and their prize money achievements this season.</p>

          <div id="winner-preview-container">
            <div class="winner-loading">Loading winner data...</div>
          </div>

          <div class="winner-summary" id="winner-summary"></div>

          <div class="u-text-center">
            <a href="winners.html" class="view-all-winners" id="winners-link"> See All Winners </a>
          </div>
        </section>

        <!-- LEADERBOARD SECTION (During Season) -->
        <section
          id="leaderboard-section"
          class="winner-scorecard season-section section-card section__card section__card--winner section__card--season section__card--during-season during-season is-hidden"
          tabindex="-1"
        >
          <h2 class="section-heading section__heading" id="leaderboard-heading">
            <span class="heading-main section__heading-main"
              ><span class="section-emoji section__emoji">üèÜ</span>Overall Leaderboard</span
            >
            <span class="heading-subtitle section__heading-subtitle" id="leaderboard-after-gw"
              >Loading‚Ä¶</span
            >
          </h2>
          <p>Complete league table showing all players ranked by their overall FPL performance.</p>

          <div id="leaderboard-container">
            <div class="leaderboard-loading">Loading league standings...</div>
          </div>

          <nav
            class="leaderboard-navigation nav__leaderboard is-hidden"
            aria-label="Leaderboard pagination"
          >
            <button
              id="leaderboard-prev-page"
              class="leaderboard-nav-btn nav__button"
              onclick="previousLeaderboardPage()"
              disabled
              title="Previous page"
            >
              ‚óÄÔ∏é Prev
            </button>
            <span id="leaderboard-page-info" class="page-info nav__page-info" aria-live="polite"
              >1 / 1</span
            >
            <button
              id="leaderboard-next-page"
              class="leaderboard-nav-btn nav__button"
              onclick="nextLeaderboardPage()"
              disabled
              title="Next page"
            >
              Next ‚ñ∂Ô∏é
            </button>
          </nav>
        </section>

        <!-- RULES SECTION -->
        <section
          id="prize-structure"
          class="winner-scorecard section-card section__card section__card--winner"
          tabindex="-1"
        >
          <h2 class="section-heading section__heading">
            <span class="heading-main section__heading-main"
              ><span class="section-emoji section__emoji">üí∞</span>Prize Breakdown</span
            >
          </h2>
          <!-- Pre-season view: keep full text (unchanged) -->
          <div id="rules-pre" class="pre-season">
            <p><strong>Entry Fee:</strong> ‚Çπ3,000</p>
            <h3>Prizes</h3>
            <ul>
              <li>
                <strong>Weekly Prizes:</strong> The top 2 managers every gameweek win cash prizes.
              </li>
              <li>
                <strong>Monthly Prizes:</strong> The 2 best managers each month are rewarded from
                the prize pool.
              </li>
              <li>
                <strong>Overall Prizes:</strong> The top 15 managers at the end of the season will
                win substantial rewards from the grand prize pool.
              </li>
            </ul>
          </div>

          <!-- During-season concise prize payouts (driven by data/prizes.json) -->
          <aside
            id="rules-season"
            class="during-season is-hidden"
            aria-labelledby="prize-structure-heading"
          >
            <h3 id="prize-structure-heading" class="visually-hidden">Prize Structure Summary</h3>
            <section class="prize-summary" id="prize-summary" aria-live="polite">
              <!-- populated by JS -->
            </section>
            <footer class="prize-meta">
              <!-- Replace dead link with modal-trigger button -->
              <button
                id="rules-btn"
                type="button"
                class="btn-primary"
                aria-haspopup="dialog"
                aria-controls="rules-modal"
                aria-expanded="false"
              >
                Mini-League Rules
              </button>
            </footer>
            <aside class="prize-note" id="prize-note" role="note"></aside>
          </aside>
        </section>

        <!-- LATE REGISTRATION SECTION (During Season) -->
        <section
          id="late-register"
          class="winner-scorecard season-section section-card section__card section__card--winner section__card--season section__card--during-season during-season is-hidden"
        >
          <h2 class="section-heading section__heading">
            <span class="heading-main section__heading-main"
              ><span class="section-emoji section__emoji">üö™</span>Missed Registration?</span
            >
          </h2>
          <p>
            Missed the initial registration? Contact us to check if late entries are still
            available.
          </p>
          <a
            href="https://forms.gle/xXRXCMKNtNMcGxsr9"
            class="cta-button"
            target="_blank"
            rel="noopener"
            >Contact for Late Entry</a
          >
        </section>

        <!-- IN-SEASON VIEW TOGGLE (Test Mode Only) - Moved to bottom for better mobile UX -->
        <section
          id="season-toggle"
          class="season-section section__card section__card--season test-only u-text-center is-hidden"
        >
          <button id="phase-toggle-btn" class="btn-primary" onclick="toggleSeasonMode()">
            üìä Preview In-season View
          </button>
          <p class="note-small">
            Quickly switch between pre-season and in-season layouts (test only)
          </p>
        </section>
      </main>

      <!-- Rules Modal -->
      <div
        id="rules-modal"
        class="modal-overlay is-hidden"
        role="dialog"
        aria-modal="true"
        aria-labelledby="rules-modal-title"
      >
        <div class="modal" role="document">
          <header class="modal-header">
            <h3 id="rules-modal-title">
              <img
                class="emoji-icon"
                src="assets/twemoji/svg/1f4c3.svg"
                alt=""
                aria-hidden="true"
              />
              Mini-League Rules
            </h3>
            <button type="button" class="modal-close" aria-label="Close rules">‚úï</button>
          </header>
          <div class="modal-body">
            <section>
              <h4>Game Week Winner</h4>
              <ul>
                <li>No cap on wins: You can win as many GWs as you manage.</li>
                <li>
                  Score used: Net GW Score = GW Points ‚àí Transfer Cost (points lost for transfers
                  are deducted).
                </li>
                <li>
                  Ties: If players have the same Net GW Score, the GW prize is split equally among
                  them.
                </li>
              </ul>
            </section>
            <section>
              <h4>Game Month Winner</h4>
              <ul>
                <li>No cap on wins: You can win multiple months.</li>
                <li>
                  Score used: The Monthly Score shown in the app ‚Äî it‚Äôs the sum of Net GW Scores for
                  all gameweeks whose start/deadline date falls in that month (GMT).
                </li>
                <li>
                  Ties: If players have the same Monthly Score, the month‚Äôs prize is split equally
                  among them.
                </li>
              </ul>
            </section>
          </div>
          <footer class="modal-footer">
            <button type="button" class="btn-primary modal-close">Got it</button>
          </footer>
        </div>
      </div>

      <footer>
        <p>developed by Aditya Garg (@addygunners)</p>
        <p id="site-last-updated" class="site-timestamp">Data updated: Loading...</p>
      </footer>
      <!-- QA PANEL (shown in test mode) -->
      <aside
        id="qa-panel"
        class="qa-panel test-only is-hidden"
        aria-live="polite"
        role="complementary"
      >
        <header class="qa-header">
          <h3>QA Panel</h3>
          <button
            id="qa-toggle"
            class="qa-toggle"
            type="button"
            aria-label="Minimize QA panel"
            aria-expanded="true"
          >
            ‚àí
          </button>
        </header>
        <dl class="qa-info">
          <dt class="visually-hidden">Phase</dt>
          <dd class="qa-kv" id="qa-phase">Phase: ‚Äî</dd>
          <dt class="visually-hidden">Next Gameweek</dt>
          <dd class="qa-kv" id="qa-gw">Next GW: ‚Äî</dd>
          <dt class="visually-hidden">Deadline</dt>
          <dd class="qa-kv" id="qa-deadline">Deadline: ‚Äî</dd>
          <dt class="visually-hidden">Season Data Source</dt>
          <dd class="qa-kv" id="qa-source">Season data source: ‚Äî</dd>
          <dt class="visually-hidden">Data Mode</dt>
          <dd class="qa-kv" id="qa-data-mode">Data mode (winners/leaderboard): ‚Äî</dd>
          <dt class="visually-hidden">Winners Updated</dt>
          <dd class="qa-kv" id="qa-winners-updated">Winners updated: ‚Äî</dd>
          <dt class="visually-hidden">Leaderboard Updated</dt>
          <dd class="qa-kv" id="qa-leaderboard-updated">Leaderboard updated: ‚Äî</dd>
          <dt class="visually-hidden">Current Time</dt>
          <dd class="qa-kv" id="qa-time">Now (offset): ‚Äî</dd>
        </dl>
        <footer class="qa-actions">
          <button id="qa-clear-cache" class="qa-btn" type="button">Clear cache</button>
          <button id="qa-refetch" class="qa-btn" type="button">Re-fetch</button>
          <button id="qa-copy" class="qa-btn" type="button">Copy</button>
        </footer>
      </aside>
      <!-- Floating phase toggle (test only) -->
      <aside
        id="floating-phase-toggle"
        class="floating-toggle test-only is-hidden"
        role="complementary"
        aria-label="Test mode controls"
      >
        üîÄ
        <button id="phase-toggle-btn-float" onclick="toggleSeasonMode()" type="button">
          Toggle phase
        </button>
        <button
          id="phase-toggle-open-winners"
          onclick="openWinnersWithToggledPhase()"
          title="Opens Winners with toggled phase; preserves test/data/clockOffset"
          type="button"
        >
          Open Winners
        </button>
      </aside>
    </div>

    <!-- === JS: MODULAR STRUCTURE === -->
    <script src="/version.js?v=1" defer></script>
    <!-- Core modules -->
    <script src="js/error-handler.js?v=1.0.5" defer></script>
    <script src="js/utils.js?v=1.0.5" defer></script>
    <script src="js/data-loader.js?v=1.0.5" defer></script>
    <script src="js/ui-manager.js?v=1.0.5" defer></script>
    <script src="js/header-scroll.js?v=1.0.5" defer></script>
    <script src="js/countdown.js?v=1.0.5" defer></script>
    <script src="js/prize-structure.js?v=1.0.5" defer></script>
    <script src="js/sw-update.js?v=1" defer></script>
    <!-- Main application script -->
    <script>
      /*
        Main application bootstrap:
        - Uses modular JavaScript architecture with separate modules for utilities, data loading, UI management, etc.
        - Initializes the application and coordinates between modules
        - Handles URL parameter processing and initial page setup

        Module structure:
        - FPLUtils: Core utilities and helpers
        - FPLDataLoader: Data loading and API management
        - FPLUIManager: UI management and display logic
        - FPLCountdown: Countdown and time management
        - FPLPrizeStructure: Prize structure management
      */

      // ===== Function Safety Utilities =====
      // Prevent ReferenceError for undefined functions
      function safeCall(obj, methodName, ...args) {
        try {
          if (obj && typeof obj[methodName] === 'function') {
            return obj[methodName](...args);
          }
          console.warn(`Function ${methodName} not available on`, obj);
          return null;
        } catch (error) {
          console.error(`Error calling ${methodName}:`, error);
          return null;
        }
      }

      function safeCallWithFallback(obj, methodName, fallback, ...args) {
        try {
          if (obj && typeof obj[methodName] === 'function') {
            return obj[methodName](...args);
          }
          console.warn(`Function ${methodName} not available, using fallback`);
          return fallback();
        } catch (error) {
          console.error(`Error calling ${methodName}, using fallback:`, error);
          return fallback();
        }
      }

      // Global function existence checker
      function checkFunctionExists(obj, methodName) {
        return obj && typeof obj[methodName] === 'function';
      }

      // ===== Application Bootstrap =====
      // Initialize URL parameters and basic configuration
      const _urlParams_boot = new URLSearchParams(window.location.search);

      // State variables
      let seasonDataSource = 'unknown'; // backend | proxy | fallback | unknown
      let usedCachedOnLoad = false;
      let countdownShown = false;
      let countdownInterval = null;
      let lastWinnersDataMode = 'auto';
      let lastWinnersDataFile = '';
      let _lastProcessedGW = null;

      // Use modular functions directly - no more wrapper functions
      // Time controls: FPLUtils.now()
      // Data source: FPLUtils.getDataOverride()
      // QA/debug state: FPLUIManager.updateQAPanel()

      // Build a query string preserving selected params for navigation
      function buildNavQuery(keys = ['test', 'data', 'phase', 'clockOffset']) {
        return FPLUtils.buildNavQuery(keys, _urlParams_boot);
      }

      // ===== Core Functions - Use Modular JavaScript Directly =====
      // Visibility: FPLUtils.show(el), FPLUtils.hide(el), FPLUtils.showGroup(selector), FPLUtils.hideGroup(selector)
      // Winner display: FPLUIManager.displayWinnerPreview(winners, containerId, summaryId)
      // Data fetching: FPLDataLoader.fetchWithRetry(url, retries)
      // Caching: FPLDataLoader.getCached/setCached functions
      // Countdown: FPLCountdown.markCountdownShown()
      // UI management: FPLUIManager.showDuringSeasonUI()

      // ------------------------------------------------------------------
      // Data loaders & helpers
      // ------------------------------------------------------------------

      // ======= SYNC BADGE FEATURE FLAG AND HELPERS =======
      // Feature flag so we can roll back easily
      const SYNC_BADGE_ENABLED = true;
      let seasonActiveLock = false;

      function removeCachedLabel() {
        const label = document.getElementById('countdown-label');
        if (!label) return;
        label.textContent = label.textContent.replace(/\s*\(cached\)$/i, '');
      }

      function showSyncedJustNow() {
        if (!SYNC_BADGE_ENABLED) return;
        const label = document.getElementById('countdown-label');
        if (!label) return;
        // Remove old badge if any
        const old = label.querySelector('.sync-badge');
        if (old) old.remove();
        const badge = document.createElement('span');
        badge.className = 'sync-badge';
        badge.textContent = 'Synced just now';
        label.appendChild(badge);
        // force reflow to trigger transition
        void badge.offsetWidth;
        badge.classList.add('show');
        // auto fade out after 2s
        setTimeout(() => {
          badge.classList.remove('show');
          setTimeout(() => badge.remove(), 350);
        }, 2000);
      }

      // ======= ADMIN BADGE (visible in ?test=true or ?admin=true) =======
      let _lastSyncIso = null;
      let _lastGwId = null;
      // last finished / processed GW according to winners data (summary.completedGameweeks)
      // (already declared at line 619)

      function isAdminMode() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('test') === 'true' || urlParams.get('admin') === 'true';
      }

      function setLastSyncInfo(gwId, iso) {
        return FPLUIManager.setLastSyncInfo(gwId, iso);
      }

      // Issue #37 Holistic Fix: Use modular system only, no duplicate functions
      function getLastFinishedGW() {
        return FPLDataLoader.getLastFinishedGW();
      }

      // Issue #37 Holistic Fix: Use modular system only
      function updateWinnersHeaderGW() {
        return FPLUIManager.updateWinnersHeaderGW();
      }

      function updateLeaderboardHeaderGW() {
        return FPLUIManager.updateLeaderboardHeaderGW();
      }

      function attachAdminBadge() {
        return FPLUIManager.attachAdminBadge();
      }

      // Load league statistics with error handling
      function loadLeagueStats() {
        return FPLDataLoader.loadLeagueStats();
      }

      /**
       * Basic countdown display for emergency fallback scenarios
       * When all other countdown systems fail, this provides minimal functionality
       */
      function displayBasicCountdown(deadline, labelText = 'Next Deadline') {
        try {
          const now = new Date();
          const timeDifference = new Date(deadline) - now;

          const countdownClock = document.getElementById('countdown-clock');
          const countdownLabel = document.getElementById('countdown-label');

          if (!countdownClock) {
            console.error('[BasicCountdown] Countdown clock element not found');
            return false;
          }

          // Show countdown
          countdownClock.style.display = 'block';
          countdownClock.classList.remove('is-hidden');

          if (countdownLabel) {
            countdownLabel.textContent = labelText;
          }

          if (timeDifference <= 0) {
            // Show LIVE status
            const daysEl = document.getElementById('countdown-days');
            if (daysEl) daysEl.textContent = 'LIVE';
            if (countdownLabel) countdownLabel.textContent = labelText.replace('Deadline', 'LIVE');
            return true;
          }

          // Calculate and display time components
          const days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
          const hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));

          const daysEl = document.getElementById('countdown-days');
          const hoursEl = document.getElementById('countdown-hours');
          const minutesEl = document.getElementById('countdown-minutes');

          if (daysEl) daysEl.textContent = days.toString().padStart(2, '0');
          if (hoursEl) hoursEl.textContent = hours.toString().padStart(2, '0');
          if (minutesEl) minutesEl.textContent = minutes.toString().padStart(2, '0');

          console.log('[BasicCountdown] Successfully displayed basic countdown');
          return true;
        } catch (error) {
          console.error('[BasicCountdown] Basic countdown display failed:', error);
          return false;
        }
      }

      // test/admin wrappers moved to js/test-admin-wrappers.js

      // Unified function to load winner data (both test and live)
      function loadWinnerData(
        containerId = 'winner-preview-container',
        summaryId = 'winner-summary',
        isTestSection = false,
        dataOverride = FPLUtils.getDataOverride()
      ) {
        const urlParams = new URLSearchParams(window.location.search);
        const testContext = urlParams.get('test') === 'true' || isTestSection;
        let useTestData = testContext;
        if (dataOverride === 'test') useTestData = true;
        if (dataOverride === 'live') useTestData = false;

        const winnersFile = useTestData ? 'data/test_winner_stats.json' : 'data/winner_stats.json';
        const winnerUrl = winnersFile + '?cache=' + new Date().getTime();

        lastWinnersDataMode = useTestData ? 'test' : 'live';
        lastWinnersDataFile = winnersFile;

        console.log(useTestData ? 'üß™ Loading TEST winner data' : 'üìä Loading LIVE winner data');
        console.log('üîç Target container ID:', containerId);
        console.log('üîç Target summary ID:', summaryId);
        console.log('üîç Fetching URL:', winnerUrl);

        // Check if containers exist
        const container = document.getElementById(containerId);
        const summary = document.getElementById(summaryId);
        console.log('üîç Container exists:', !!container);
        console.log('üîç Summary exists:', !!summary);

        return FPLDataLoader.fetchWithRetry(winnerUrl, 3)
          .then((data) => {
            console.log(`${useTestData ? 'üß™ Loaded TEST' : 'üìä Loaded LIVE'} winner data:`, data);

            // Add test mode indicator if needed
            if (useTestData && data.testMode) {
              const headerP = document.querySelector('header p');
              if (headerP && !headerP.textContent.includes('[TEST MODE]')) {
                headerP.textContent = headerP.textContent + ' [TEST MODE - Demo Data]';
                headerP.style.color = '#ff6b6b';
              }
            }

            displayWinnerPreview(data.winners, containerId, summaryId);

            // Issue #37 Critical Fix: Ensure data-loader also captures this data
            // This syncs both the UI Manager and Data Loader modules
            FPLDataLoader.loadWinnerPreview()
              .then(() => {
                console.debug('[GW] Successfully synced winner data with data-loader');
                // Refresh any headers that show "After GWx" after syncing
                try {
                  updateWinnersHeaderGW();
                  updateLeaderboardHeaderGW();
                } catch (e) {
                  console.warn('Header update failed after sync:', e);
                }
              })
              .catch((e) => {
                console.warn('Failed to sync winner data with data-loader:', e);
                // Still try to update headers with current data
                try {
                  updateWinnersHeaderGW();
                  updateLeaderboardHeaderGW();
                } catch (e2) {
                  console.warn('Header update failed:', e2);
                }
              });
            if (window.FPLUIManager && typeof FPLUIManager.updateQAPanel === 'function') {
              FPLUIManager.updateQAPanel();
            }
            return data;
          })
          .catch((error) => {
            console.error(`Winner fetch error (${useTestData ? 'test' : 'live'}):`, error);
            const errorHTML = `
              <div class="winner-error">
                <h3>Unable to load winner data</h3>
                <p>There was a problem loading the winner statistics. Please try again.</p>
          <button onclick="loadWinnerData('${containerId}', '${summaryId}', ${isTestSection})"
                        style="background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                  üîÑ Retry
                </button>
              </div>
            `;
            document.getElementById(containerId).innerHTML = errorHTML;
          });
      }

      // ===== Prize structure (during season) =====
      function formatINR(n) {
        try {
          return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            maximumFractionDigits: 0,
          }).format(n);
        } catch {
          return `‚Çπ${n}`;
        }
      }

      function sumAmounts(list) {
        return (list || []).reduce((s, x) => s + (Number(x.amount) || 0), 0);
      }

      function iconImg(code, alt) {
        return `<img class="emoji-icon" src="assets/twemoji/svg/${code}.svg" alt="${alt}">`;
      }

      function buildWeeklyCard(weekly) {
        const total = sumAmounts(weekly);
        const topTwo = (weekly || [])
          .filter((p) => p.rank === 1 || p.rank === 2)
          .sort((a, b) => a.rank - b.rank);
        const pills = topTwo
          .map((p) => {
            const cls = p.rank === 1 ? 'pill-gold' : 'pill-silver';
            return `<span class="pill ${cls}"><span class="rank">${ordinal(p.rank)}</span>${formatINR(p.amount)}</span>`;
          })
          .join('');
        return `
          <article class="prize-card" aria-labelledby="weekly-prize-title">
            <div class="pc-line icon-line" aria-hidden="true">${iconImg('1f4c5', 'Calendar')}</div>
            <div class="pc-line pc-label" id="weekly-prize-title">Weekly</div>
            <div class="pc-line amount" aria-label="Total weekly prize amount">${formatINR(total)}</div>
            <div class="pc-line breakdown" aria-label="Top prizes">${pills}</div>
          </article>`;
      }

      function buildMonthlyCard(monthly) {
        const total = sumAmounts(monthly);
        const topTwo = (monthly || [])
          .filter((p) => p.rank === 1 || p.rank === 2)
          .sort((a, b) => a.rank - b.rank);
        const pills = topTwo
          .map((p) => {
            const cls = p.rank === 1 ? 'pill-gold' : 'pill-silver';
            return `<span class="pill ${cls}"><span class="rank">${ordinal(p.rank)}</span>${formatINR(p.amount)}</span>`;
          })
          .join('');
        return `
          <article class="prize-card" aria-labelledby="monthly-prize-title">
            <div class="pc-line icon-line" aria-hidden="true">${iconImg('1f5d3', 'Spiral calendar')}</div>
            <div class="pc-line pc-label" id="monthly-prize-title">Monthly</div>
            <div class="pc-line amount" aria-label="Total monthly prize amount">${formatINR(total)}</div>
            <div class="pc-line breakdown" aria-label="Top prizes">${pills}</div>
          </article>`;
      }

      function ordinal(n) {
        return n === 1 ? '1st' : n === 2 ? '2nd' : n === 3 ? '3rd' : n + 'th';
      }

      function buildAnnualCard(annual) {
        const totalOverallPrize = sumAmounts(annual);
        const topThree = (annual || [])
          .slice(0, 3)
          .map((p) => {
            const cls = p.rank === 1 ? 'pill-gold' : p.rank === 2 ? 'pill-silver' : 'pill-bronze';
            return `<span class=\"pill ${cls}\"><span class=\"rank\">${ordinal(p.rank)}</span>${formatINR(p.amount)}</span>`;
          })
          .join('');

        const allList = (annual || [])
          .slice(0, 15)
          .map(
            (p) => `
              <div class="more-item">
                <span class="rank">${ordinal(p.rank)}</span>
                <span class="value">${formatINR(p.amount)}</span>
              </div>`
          )
          .join('');

        const panelId = 'annual-tip-panel';
        const btnId = 'annual-tip-btn';

        return `
          <article class="prize-card" aria-labelledby="annual-prize-title">
            <div class="overlay-action" id="${btnId}" aria-label="View top 15 prizes" aria-haspopup="dialog" aria-controls="${panelId}" aria-expanded="false"><span class="dots-icon" aria-hidden="true">‚ãØ</span></div>
            <div class="pc-line icon-line" aria-hidden="true">${iconImg('1f3c6', 'Trophy')}</div>
            <div class="pc-line pc-label" id="annual-prize-title">Overall</div>
            <div class="pc-line amount" aria-label="Total annual prize amount">${formatINR(totalOverallPrize)}</div>
            <div class="pc-line breakdown" aria-label="Top three prizes">${topThree}</div>
            <div id="${panelId}" class="tooltip-panel" role="dialog" aria-label="Top 15 prizes" hidden>
              <div class="more-list">${allList}</div>
            </div>
          </article>`;
      }

      function renderPrizeStructure(data) {
        const container = document.getElementById('prize-summary');
        const meta = document.getElementById('prize-last-updated');
        const note = document.getElementById('prize-note');
        if (!container) return;
        const weekly = buildWeeklyCard(data.weeklyPrizes || []);
        const monthly = buildMonthlyCard(data.monthlyPrizes || []);
        const annual = buildAnnualCard(data.annualPrizes || []);
        container.innerHTML = `${weekly}${monthly}${annual}`;
        // Wire up annual toggle
        const btn = document.getElementById('annual-tip-btn');
        const panel = document.getElementById('annual-tip-panel');
        if (btn && panel) {
          function closePanel() {
            panel.classList.remove('open');
            btn.setAttribute('aria-expanded', 'false');
            setTimeout(() => (panel.hidden = true), 150);
            document.removeEventListener('click', onDocClick, true);
            window.removeEventListener('keydown', onKey);
          }
          function onDocClick(e) {
            if (panel.contains(e.target) || btn.contains(e.target)) return;
            closePanel();
          }
          function onKey(e) {
            if (e.key === 'Escape') closePanel();
          }
          btn.addEventListener('click', function (e) {
            e.stopPropagation();
            const opening = !panel.classList.contains('open');
            if (opening) {
              panel.hidden = false;
              requestAnimationFrame(() => panel.classList.add('open'));
              btn.setAttribute('aria-expanded', 'true');
              document.addEventListener('click', onDocClick, true);
              window.addEventListener('keydown', onKey);
            } else {
              closePanel();
            }
          });
        }
        if (window.applyTwemoji) {
          window.applyTwemoji(container);
        }
        // Entry fee line above cards (keeps layout consistent with request)
        const rulesSection = document.getElementById('rules-season');
        if (rulesSection && !rulesSection.querySelector('.entry-fee')) {
          const p = document.createElement('p');
          p.className = 'entry-fee';
          p.innerHTML = `<strong>Entry Fee:</strong> ${formatINR(3000)}`; // Provided requirement
          rulesSection.insertBefore(p, container.parentNode ? container : rulesSection.firstChild);
        }
        if (meta) {
          try {
            const d = new Date(data.lastUpdated);
            const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            meta.textContent =
              'Updated ' +
              d.toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short', timeZone: tz });
          } catch {
            meta.textContent = 'Updated recently';
          }
        }
        if (note && data.note) note.textContent = data.note;
      }

      function loadPrizeSummary() {
        const url = 'data/prizes.json?cache=' + Date.now();
        console.log('Loading prize summary from:', url);
        return FPLDataLoader.fetchWithRetry(url, 2)
          .then((data) => {
            console.log('Prize data loaded:', data);
            renderPrizeStructure(data);
            if (data.lastUpdated) {
              FPLDataLoader.updateDataTimestamp('prizes', data.lastUpdated);
            }
            return data;
          })
          .catch((err) => {
            console.error('Prize load failed:', err);
            // Show error message in the container
            const container = document.getElementById('prize-summary');
            if (container) {
              container.innerHTML =
                '<div class="winner-error">Unable to load prize structure. Please refresh the page.</div>';
            }
          });
      }

      // Consolidated function to load test winner data
      function loadTestWinnerData() {
        loadWinnerData('test-winner-preview-container', 'test-winner-summary', true);
      }

      document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ DOM Content Loaded - Starting initialization');

        // ===== Module Availability Check =====
        const requiredModules = {
          FPLUtils: window.FPLUtils,
          FPLDataLoader: window.FPLDataLoader,
          FPLUIManager: window.FPLUIManager,
          FPLCountdown: window.FPLCountdown,
          ErrorHandler: window.ErrorHandler,
        };

        const missingModules = [];
        const availableModules = [];

        Object.entries(requiredModules).forEach(([name, module]) => {
          if (module && typeof module === 'object') {
            availableModules.push(name);
          } else {
            missingModules.push(name);
          }
        });

        console.log('‚úÖ Available modules:', availableModules);
        if (missingModules.length > 0) {
          console.warn('‚ö†Ô∏è Missing modules:', missingModules);
          console.warn('Some functionality may be limited');
        }

        // DOMContentLoaded bootstrap: decides test vs live mode, attempts cached deadlines
        // (only in test mode), sets up countdown safety fallback and loads league_stats.json
        // The majority of UI wiring happens in loadFPLSeasonData() and handleSeasonDisplay().
        // Check if we're in test mode first
        const urlParams = new URLSearchParams(window.location.search);
        const isTestMode = urlParams.get('test') === 'true';

        console.log('üîç Test mode:', isTestMode);
        console.log('üîç Available modules:', {
          FPLUtils: typeof window.FPLUtils,
          FPLUIManager: typeof window.FPLUIManager,
          FPLDataLoader: typeof window.FPLDataLoader,
          FPLCountdown: typeof window.FPLCountdown,
        });

        if (!isTestMode) {
          // For live mode, clear any cached gameweek data that might show during-season UI
          // This ensures we always start fresh in pre-season mode for live users
          console.log('üßπ Live mode: Clearing cached gameweek data to ensure pre-season UI');
          try {
            localStorage.removeItem('fpl_cached_gw');
          } catch (e) {
            // ignore storage errors
          }
        }

        // Only use cached deadline in test mode to avoid showing "cached" in live mode
        if (isTestMode) {
          const cachedDeadline = safeCall(window.FPLDataLoader, 'getCachedDeadline');
          if (
            cachedDeadline &&
            safeCall(window.FPLUtils, 'now') &&
            cachedDeadline - FPLUtils.now() > 0
          ) {
            const countdownClock = document.getElementById('countdown-clock');
            if (countdownClock) safeCall(window.FPLUtils, 'show', countdownClock);
            const label = document.getElementById('countdown-label');
            if (label && !label.textContent.includes('(cached)')) {
              label.textContent = label.textContent + ' (cached)';
            }
            usedCachedOnLoad = true;
            safeCall(window, 'handleSeasonDisplay', cachedDeadline);
            safeCall(window.FPLCountdown, 'startCountdown', cachedDeadline);
            safeCall(window.FPLCountdown, 'markCountdownShown');
          }
        }

        // Don't use cached gameweek data in DOM ready - let test mode start with pre-season view
        // The toggle button will handle switching to during-season view when clicked
        // Load FPL season data first
        loadFPLSeasonData();

        // Headers will be updated when data loads (lines 1018, 1334)

        // Enhanced safety fallback with multiple layers of error recovery
        setTimeout(() => {
          try {
            const countdownShown = safeCall(window.FPLCountdown, 'isCountdownShown') || false;
            console.log('‚è∞ Safety fallback timeout triggered, countdownShown:', countdownShown);

            if (!countdownShown) {
              console.warn('[Countdown] Safety fallback engaged - attempting recovery');

              const countdownClock = document.getElementById('countdown-clock');
              const label = document.getElementById('countdown-label');

              // Show countdown elements with fallback DOM methods
              if (countdownClock) {
                if (!safeCall(window.FPLUtils, 'show', countdownClock)) {
                  // FPLUtils failed, use direct DOM manipulation
                  countdownClock.classList.remove('is-hidden');
                  countdownClock.style.display = 'block';
                }
              }

              if (label) label.textContent = 'Fetching next deadline‚Ä¶';

              // Try cached data first
              const cachedGW = safeCall(window.FPLDataLoader, 'getCachedGameweek');
              if (cachedGW && cachedGW.id && cachedGW.deadline_time) {
                console.log('[Fallback] Using cached gameweek data:', cachedGW);

                try {
                  const deadline = new Date(cachedGW.deadline_time);
                  if (!isNaN(deadline.getTime())) {
                    // Try full startup flow
                    const handleSuccess = safeCall(
                      window,
                      'handleSeasonDisplay',
                      deadline,
                      cachedGW
                    );
                    const countdownSuccess = safeCall(
                      window.FPLCountdown,
                      'startCountdown',
                      deadline,
                      cachedGW
                    );

                    if (!countdownSuccess) {
                      // If module countdown failed, try basic fallback
                      console.warn('[Fallback] Module countdown failed, trying basic display');
                      displayBasicCountdown(deadline, `GW${cachedGW.id} Deadline`);
                    }
                  } else {
                    console.error('[Fallback] Invalid cached deadline format');
                  }
                } catch (deadlineError) {
                  console.error('[Fallback] Error processing cached deadline:', deadlineError);
                }
              } else {
                console.warn('[Fallback] No valid cached gameweek data available');

                // Attempt a fresh load via shared loader
                const freshLoadResult = safeCall(window, 'loadFPLSeasonData');
                if (!freshLoadResult) {
                  // Last resort: show generic countdown message
                  if (label) label.textContent = 'Next deadline loading...';
                  console.warn(
                    '[Fallback] All recovery methods exhausted, showing generic message'
                  );
                }
              }

              // Update QA panel if available
              try {
                if (window.FPLUIManager && typeof FPLUIManager.updateQAPanel === 'function') {
                  FPLUIManager.updateQAPanel();
                }
              } catch (qaError) {
                console.warn('[Fallback] QA panel update failed:', qaError);
              }
            }
          } catch (fallbackError) {
            console.error('[Countdown] Critical error in safety fallback:', fallbackError);
            // Last resort: ensure countdown is visible with basic message
            const countdownClock = document.getElementById('countdown-clock');
            const label = document.getElementById('countdown-label');
            if (countdownClock) {
              countdownClock.style.display = 'block';
              countdownClock.classList.remove('is-hidden');
            }
            if (label) label.textContent = 'Loading...';
          }
        }, 1500);

        // Load league stats with error handling
        loadLeagueStats();

        // Add this at the end (test/admin-only)
        if (window.FPLUIManager && typeof FPLUIManager.checkTestMode === 'function') {
          FPLUIManager.checkTestMode();
        }

        /*
          Contributor notes / quick runbook (same patterns as winners.html):

          - Serve this folder with a static server for local testing:
              python3 -m http.server
            then open http://localhost:8000/index.html

          - Try query params for debugging:
              ?test=true          -> show test UI and load demo data
              ?data=test|live     -> force which winners dataset to use
              ?debug=1            -> enable verbose logging
              ?clockOffset=3600000-> shift clock by +1 hour (ms)

          - Edit `data/test_winner_stats.json` and `data/league_stats.json` to create
            predictable datasets for onboarding new contributors.
        */
      });

      function loadFPLSeasonData() {
        console.log('üì° loadFPLSeasonData called (delegating to shared module)');
        if (!window.FPLDataLoader) {
          console.error('FPLDataLoader not available');
          return;
        }
        FPLDataLoader.loadFPLSeasonData()
          .then(({ deadline, gameweek }) => {
            try {
              seasonDataSource = FPLDataLoader.getSeasonDataSource();
            } catch {}
            console.log('üéØ Using season data from module:', {
              deadline,
              gameweek,
              seasonDataSource,
            });

            // Issue #37 Final Fix: After season data loads, ensure winner data is synced BEFORE updating headers
            FPLDataLoader.loadWinnerPreview()
              .then(() => {
                console.debug('[GW] Season data loaded, winner data synced, now updating headers');
                // Now both modules have consistent data - update headers
                try {
                  updateWinnersHeaderGW();
                  updateLeaderboardHeaderGW();
                } catch (e) {
                  console.warn('Header GW update failed after sync:', e);
                }
              })
              .catch((e) => {
                console.warn('Failed to sync winner data after season load:', e);
                // Still try to update headers
                try {
                  updateWinnersHeaderGW();
                  updateLeaderboardHeaderGW();
                } catch (e2) {
                  console.warn('Header GW update failed:', e2);
                }
              });

            // Delegate UI and countdown to shared modules
            try {
              handleSeasonDisplay(deadline, gameweek);
              FPLCountdown.startCountdown(deadline, gameweek);
              FPLCountdown.markCountdownShown();
              // Use shared rollover scheduler
              scheduleRolloverCheck(deadline);
              attachAdminBadge();
              if (window.FPLUIManager && typeof FPLUIManager.updateQAPanel === 'function') {
                FPLUIManager.updateQAPanel();
              }
            } catch (e) {
              console.error('Post-load wiring failed:', e);
            }
          })
          .catch((err) => {
            console.error('loadFPLSeasonData (module) failed:', err);
            // As a last resort, try the shared proxy loader directly
            if (FPLDataLoader.loadFPLSeasonDataViaProxy) {
              FPLDataLoader.loadFPLSeasonDataViaProxy()
                .then(({ deadline, gameweek }) => {
                  try {
                    seasonDataSource = FPLDataLoader.getSeasonDataSource();
                  } catch {}
                  handleSeasonDisplay(deadline, gameweek);
                  FPLCountdown.startCountdown(deadline, gameweek);
                  scheduleRolloverCheck(deadline);
                  if (window.FPLUIManager && typeof FPLUIManager.updateQAPanel === 'function') {
                    FPLUIManager.updateQAPanel();
                  }
                })
                .catch((e2) => console.error('Proxy fallback failed:', e2));
            }
          });
      }

      function scheduleRolloverCheck(deadline) {
        // Delegate to shared countdown scheduler to avoid divergence and bugs
        try {
          if (window.FPLCountdown && typeof FPLCountdown.scheduleRolloverCheck === 'function') {
            FPLCountdown.scheduleRolloverCheck(deadline);
          } else {
            console.warn('FPLCountdown.scheduleRolloverCheck not available');
          }
        } catch (e) {
          console.error('scheduleRolloverCheck delegation failed:', e);
        }
      }

      function loadFPLSeasonDataViaProxy() {
        // Delegate to shared module implementation for proxies
        if (!FPLDataLoader || typeof FPLDataLoader.loadFPLSeasonDataViaProxy !== 'function') {
          console.error('Proxy loader not available');
          return;
        }
        FPLDataLoader.loadFPLSeasonDataViaProxy()
          .then(({ deadline, gameweek }) => {
            try {
              seasonDataSource = FPLDataLoader.getSeasonDataSource();
            } catch {}
            handleSeasonDisplay(deadline, gameweek);
            FPLCountdown.startCountdown(deadline, gameweek);
            scheduleRolloverCheck(deadline);
          })
          .catch((e) => console.error('Proxy loader failed:', e));
      }

      function handleSeasonDisplay(seasonStartDate, gameweek = null) {
        console.log('üéØ handleSeasonDisplay called with:', { seasonStartDate, gameweek });
        console.log('üéØ Delegating to FPLUIManager.handleSeasonDisplay');
        return FPLUIManager.handleSeasonDisplay(seasonStartDate, gameweek);
      }

      // Removed duplicate startCountdown function - using FPLCountdown.startCountdown() instead

      // Removed duplicate updateCountdownDisplay function - using FPLCountdown.updateCountdownDisplay() instead

      // Removed duplicate updateGameweekCountdown function - using FPLCountdown.updateGameweekCountdown() instead

      // Main winner data loader - now uses the unified function with data override
      function loadMainWinnerData() {
        return FPLUIManager.loadMainWinnerData();
      }

      // Legacy function
      function loadMainWinnerDataLegacy() {
        const urlParams = new URLSearchParams(window.location.search);
        const isTestMode = urlParams.get('test') === 'true';
        const dataOverride = FPLUtils.getDataOverride();

        loadWinnerData('winner-preview-container', 'winner-summary', false, dataOverride).then(
          (data) => {
            if (data) {
              // Show last updated time for winners
              const lastUpdated = new Date(data.lastUpdated);
              const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
              const formattedDate = lastUpdated.toLocaleString('en-GB', {
                dateStyle: 'medium',
                timeStyle: 'short',
                timeZone: userTimeZone,
              });

              const usedTest =
                lastWinnersDataMode === 'test' || (dataOverride === 'auto' && isTestMode);
              const updateText = usedTest
                ? `Last updated: ${formattedDate} (test data)`
                : `Last updated: ${formattedDate} (your local time)`;

              const updateElement = document.getElementById('winner-last-updated');
              if (updateElement) {
                updateElement.textContent = updateText;
              }
              // Track for QA panel
              try {
                lastWinnersUpdatedIso = data.lastUpdated || lastUpdated.toISOString();
                FPLDataLoader.updateDataTimestamp('winners', data.lastUpdated);
              } catch {}
              if (window.FPLUIManager && typeof FPLUIManager.updateQAPanel === 'function') {
                FPLUIManager.updateQAPanel();
              }
            }
          }
        );
      }

      // Unified display function for winner previews
      function displayWinnerPreview(
        winners,
        containerId = 'winner-preview-container',
        summaryId = 'winner-summary'
      ) {
        console.log('üé® displayWinnerPreview called with:');
        console.log('  - containerId:', containerId);
        console.log('  - summaryId:', summaryId);
        console.log('  - winners count:', winners ? winners.length : 0);

        const container = document.getElementById(containerId);
        const summaryContainer = document.getElementById(summaryId);

        console.log('  - container found:', !!container);
        console.log('  - summary container found:', !!summaryContainer);

        if (!container) {
          console.error(`Container ${containerId} not found`);
          return;
        }

        if (!winners || winners.length === 0) {
          console.log('‚ö†Ô∏è No winners data, showing loading message');
          container.innerHTML = '<div class="winner-loading">No winner data available yet.</div>';
          return;
        }

        // Sort winners by total prize won (descending) - higher prize amount = better position
        const sortedWinners = winners
          .filter((winner) => winner.totalPrizeWon > 0) // Only include players who have won prizes
          .sort((a, b) => b.totalPrizeWon - a.totalPrizeWon);

        // Show top 6 winners in preview
        const topWinners = sortedWinners.slice(0, 6);

        const previewHTML = `
          <div class="winner-preview winner__preview" aria-label="Top prize winners">
            ${topWinners
              .map(
                (winner, index) => `
              <article class="winner-card winner__card${
                index < 3 ? ` rank-${index + 1} winner__card--rank-${index + 1}` : ''
              }" aria-labelledby="winner-name-${index}">
                <div class="winner-rank winner__rank" aria-label="Position">#${index + 1}</div>
                <p id="winner-name-${index}" class="winner-name winner__name" title="${escapeHTML(winner.playerName)}">${escapeHTML(winner.playerName)}</p>
                <div class="winner-prize winner__prize" title="Total prize won: ‚Çπ${winner.totalPrizeWon.toLocaleString(
                  'en-IN'
                )}" aria-label="Total prize won">
                  ‚Çπ${winner.totalPrizeWon.toLocaleString('en-IN')}
                </div>
                <div class="winner-highlights winner__highlights" aria-label="Achievements">
                  ${
                    winner.highlights.gameWeeks > 0
                      ? `<span class="highlight-badge gw" title="${escapeHTML(winner.highlights.gameWeeks + ' gameweek wins')}">${escapeHTML(winner.highlights.gameWeeks + 'GW')}</span>`
                      : ''
                  }
                  ${
                    winner.highlights.gameMonths > 0
                      ? `<span class="highlight-badge gm" title="${escapeHTML(winner.highlights.gameMonths + ' monthly wins')}">${escapeHTML(winner.highlights.gameMonths + 'GM')}</span>`
                      : ''
                  }
                  ${
                    winner.highlights.overallRank
                      ? `<span class="highlight-badge" title="Current league position">League Rank ${escapeHTML(winner.highlights.overallRank)}</span>`
                      : ''
                  }
                </div>
              </article>
            `
              )
              .join('')}
          </div>
        `;

        container.innerHTML = previewHTML;

        // Show summary if summary container exists
        if (summaryContainer) {
          const totalWinners = winners.length;
          const totalPrizeMoney = winners.reduce((sum, winner) => sum + winner.totalPrizeWon, 0);
          summaryContainer.textContent = `Showing top 6 of ${totalWinners} winners ‚Ä¢ Total prize money distributed: ‚Çπ${totalPrizeMoney.toLocaleString('en-IN')}`;
        }
      }

      // Debounced resize handler for better performance
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      function adjustForZFold() {
        const width = window.innerWidth;
        const h1 = document.querySelector('header h1');

        if (width <= 360 && h1) {
          // Only change for ultra-narrow screens - update title container
          const titleContainer = document.querySelector('.title-with-logo');
          if (titleContainer) {
            titleContainer.innerHTML = `
              <span class=\"header-icon\">‚öΩ</span>
              <span>IIM-M Fantasy League</span>
              <img src=\"FPL logo.jpg\" alt=\"FPL\" class=\"fpl-logo\" title=\"Fantasy Premier League\">
            `;
          }
        } else {
          // Restore original for all other screens
          const titleContainer = document.querySelector('.title-with-logo');
          if (titleContainer) {
            titleContainer.innerHTML = `
              <span class=\"header-icon\">‚öΩ</span>
              <span>IIM Mumbai Fantasy League</span>
              <img src=\"FPL logo.jpg\" alt=\"Fantasy Premier League\" class=\"fpl-logo\" title=\"Fantasy Premier League\">
            `;
          }
          h1.style.fontSize = ''; // Clear any inline styles
          h1.style.whiteSpace = ''; // Clear any inline styles
          h1.style.overflow = ''; // Clear any inline styles
          h1.style.textOverflow = ''; // Clear any inline styles
        }
      }

      // Performance optimizations
      const debouncedAdjustForZFold = debounce(adjustForZFold, 250);

      // Enhanced error handling for missing elements
      function safeElementUpdate(elementId, content, fallback = '--') {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = content;
        } else {
          console.warn(`Element with ID '${elementId}' not found, using fallback`);
        }
      }

      // Service worker registration moved to js/sw-update.js (with update prompt)

      // =============== LEADERBOARD FUNCTIONS ===============

      // Global variables for leaderboard pagination
      let leaderboardData = [];
      let currentLeaderboardPage = 1;
      const leaderboardItemsPerPage = 10;

      // Load test leaderboard data
      function loadTestLeaderboardData() {
        return FPLDataLoader.loadTestLeaderboardData();
      }

      // Legacy function
      function loadTestLeaderboardDataLegacy() {
        lastLeaderboardDataMode = 'test';
        const winnerUrl = 'data/test_winner_stats.json?cache=' + new Date().getTime();
        lastLeaderboardDataFile = 'data/test_winner_stats.json';
        console.log('üß™ Loading TEST leaderboard data for toggle');

        return FPLDataLoader.fetchWithRetry(winnerUrl, 3)
          .then((data) => {
            console.log('üß™ Loaded TEST leaderboard data for toggle:', data);

            if (data.winners) {
              // Prefer pure test data for standings in test mode, but if live data exists, merge.
              const liveUrl = 'data/winner_stats.json?cache=' + new Date().getTime();

              return fetch(liveUrl)
                .then((response) => response.json())
                .then((liveData) => {
                  const hasLiveWinners =
                    Array.isArray(liveData.winners) && liveData.winners.length > 0;

                  if (!hasLiveWinners) {
                    // Live data is empty ‚Äî use test data directly so the table is populated.
                    leaderboardData = data.winners
                      .filter(
                        (winner) =>
                          winner.highlights &&
                          winner.highlights.overallRank !== null &&
                          winner.highlights.overallRank !== undefined
                      )
                      .sort((a, b) => a.highlights.overallRank - b.highlights.overallRank);
                  } else {
                    // Merge: overlay test ranks/details on top of live roster where available.
                    const testWinnersMap = new Map();
                    data.winners.forEach((winner) => {
                      testWinnersMap.set(winner.playerName, winner);
                    });

                    leaderboardData = liveData.winners
                      .map((player) => {
                        const testData = testWinnersMap.get(player.playerName);
                        if (testData) {
                          return { ...testData };
                        }
                        // Keep live player; if no rank in live, push to bottom with placeholder
                        const rank = player?.highlights?.overallRank;
                        return {
                          ...player,
                          highlights: {
                            ...player.highlights,
                            overallRank:
                              rank !== null && rank !== undefined
                                ? rank
                                : 1999 + Math.random() * 1000,
                          },
                        };
                      })
                      .filter(
                        (p) =>
                          p.highlights &&
                          p.highlights.overallRank !== null &&
                          p.highlights.overallRank !== undefined
                      )
                      .sort((a, b) => a.highlights.overallRank - b.highlights.overallRank);
                  }

                  displayLeaderboard();

                  // Show last updated time (from test data)
                  const lastUpdated = new Date(data.lastUpdated);
                  const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                  const formattedDate = lastUpdated.toLocaleString('en-GB', {
                    dateStyle: 'medium',
                    timeStyle: 'short',
                    timeZone: userTimeZone,
                  });

                  const updateElement = document.getElementById('leaderboard-last-updated');
                  if (updateElement) {
                    updateElement.textContent = `Last updated: ${formattedDate} (test data)`;
                  }
                  try {
                    lastLeaderboardUpdatedIso = data.lastUpdated || lastUpdated.toISOString();
                    FPLDataLoader.updateDataTimestamp('leaderboard', data.lastUpdated);
                  } catch {}
                  if (window.FPLUIManager && typeof FPLUIManager.updateQAPanel === 'function') {
                    FPLUIManager.updateQAPanel();
                  }
                  return data;
                })
                .catch((fetchError) => {
                  console.error('Error fetching live data for comparison:', fetchError);
                  // Fallback to just test data
                  leaderboardData = data.winners
                    .filter(
                      (winner) =>
                        winner.highlights &&
                        winner.highlights.overallRank !== null &&
                        winner.highlights.overallRank !== undefined
                    )
                    .sort((a, b) => a.highlights.overallRank - b.highlights.overallRank);

                  displayLeaderboard();

                  const lastUpdated = new Date(data.lastUpdated);
                  const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                  const formattedDate = lastUpdated.toLocaleString('en-GB', {
                    dateStyle: 'medium',
                    timeStyle: 'short',
                    timeZone: userTimeZone,
                  });

                  const updateElement = document.getElementById('leaderboard-last-updated');
                  if (updateElement) {
                    updateElement.textContent = `Last updated: ${formattedDate} (test data)`;
                  }
                  try {
                    lastLeaderboardUpdatedIso = data.lastUpdated || lastUpdated.toISOString();
                    FPLDataLoader.updateDataTimestamp('leaderboard', data.lastUpdated);
                  } catch {}
                  if (window.FPLUIManager && typeof FPLUIManager.updateQAPanel === 'function') {
                    FPLUIManager.updateQAPanel();
                  }
                  return data;
                });
            }

            return data;
          })
          .catch((error) => {
            console.error('Test leaderboard fetch error:', error);
            const container = document.getElementById('leaderboard-container');
            if (container) {
              container.innerHTML = `
                <div class="winner-error">
                  <h3>Unable to load test league standings</h3>
                  <p>There was a problem loading the test league standings. Please try again.</p>
                  <button onclick="loadTestLeaderboardData()"
                          style="background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-top: 10px;">üîÑ Retry</button>
                </div>
              `;
            }
          });
      }

      // Load leaderboard data from the same winner_stats.json
      function loadLeaderboardData() {
        return FPLDataLoader.loadLeaderboardData();
      }

      // Legacy function
      function loadLeaderboardDataLegacy() {
        const urlParams = new URLSearchParams(window.location.search);
        const isTestParam = urlParams.get('test') === 'true';
        const dataOverride = FPLUtils.getDataOverride();
        let useTestData = isTestParam;
        if (dataOverride === 'test') useTestData = true;
        if (dataOverride === 'live') useTestData = false;

        const lbFile = useTestData ? 'data/test_winner_stats.json' : 'data/winner_stats.json';
        const winnerUrl = lbFile + '?cache=' + new Date().getTime();

        lastLeaderboardDataMode = useTestData ? 'test' : 'live';
        lastLeaderboardDataFile = lbFile;

        console.log(
          useTestData ? 'üß™ Loading TEST leaderboard data' : 'üìä Loading LIVE leaderboard data'
        );

        return FPLDataLoader.fetchWithRetry(winnerUrl, 3)
          .then((data) => {
            console.log(
              `${useTestData ? 'üß™ Loaded TEST' : 'üìä Loaded LIVE'} leaderboard data:`,
              data
            );

            if (data.winners) {
              // Sort by overall rank (ascending) - lower rank number = better position
              let winnersData = data.winners
                .filter(
                  (winner) =>
                    winner.highlights &&
                    winner.highlights.overallRank !== null &&
                    winner.highlights.overallRank !== undefined
                ) // Include all players with a rank (including rank 0)
                .sort((a, b) => a.highlights.overallRank - b.highlights.overallRank);

              // ENHANCEMENT: Process enhanced JSON data if available
              try {
                console.log('üèÜ Checking for enhanced leaderboard data...');

                // Check if this is enhanced JSON (has enhancement metadata)
                const isEnhancedJson = data.enhancements?.leaderboardEnhanced === true;

                if (isEnhancedJson) {
                  console.log('‚úÖ Enhanced JSON detected, using server-side enhancements');
                  // Enhanced JSON already has movement, current GW points, and deficit data
                  // Just ensure proper ordering and any missing fallback processing
                  leaderboardData = winnersData;
                } else {
                  console.log('‚ÑπÔ∏è Standard JSON detected, applying frontend enhancements');

                  // Apply frontend enhancement modules for backward compatibility
                  if (window.LeaderboardEnhancement && window.CurrentGWPoints) {
                    // First enhance with current GW points
                    winnersData = CurrentGWPoints.enhancePlayersWithCurrentGW(winnersData);

                    // Then add movement indicators and deficit calculations
                    winnersData = LeaderboardEnhancement.enhanceLeaderboardData(winnersData);

                    console.log('‚úÖ Frontend enhancement modules applied successfully');
                  } else {
                    console.warn('‚ö†Ô∏è Enhancement modules not available, using basic data');
                  }

                  leaderboardData = winnersData;
                }

                // Store enhanced data globally for modular access
                window.leaderboardData = leaderboardData;

                console.log(
                  'üìä Enhanced leaderboard data ready:',
                  leaderboardData.length,
                  'players'
                );
              } catch (enhancementError) {
                console.error('‚ùå Error applying leaderboard enhancements:', enhancementError);
                // Fallback to basic data processing
                leaderboardData = winnersData;
              }

              displayLeaderboard();

              // Show last updated time
              const lastUpdated = new Date(data.lastUpdated);
              const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
              const formattedDate = lastUpdated.toLocaleString('en-GB', {
                dateStyle: 'medium',
                timeStyle: 'short',
                timeZone: userTimeZone,
              });

              const updateText = useTestData
                ? `Last updated: ${formattedDate} (test data)`
                : `Last updated: ${formattedDate} (your local time)`;

              const updateElement = document.getElementById('leaderboard-last-updated');
              if (updateElement) {
                updateElement.textContent = updateText;
              }
              // Track for QA panel
              try {
                lastLeaderboardUpdatedIso = data.lastUpdated || lastUpdated.toISOString();
                FPLDataLoader.updateDataTimestamp('leaderboard', data.lastUpdated);
              } catch {}
              if (window.FPLUIManager && typeof FPLUIManager.updateQAPanel === 'function') {
                FPLUIManager.updateQAPanel();
              }
            }

            return data;
          })
          .catch((error) => {
            console.error(`Leaderboard fetch error (${useTestData ? 'test' : 'live'}):`, error);
            const container = document.getElementById('leaderboard-container');
            if (container) {
              container.innerHTML = `
                <div class="winner-error">
                  <h3>Unable to load league standings</h3>
                  <p>There was a problem loading the league standings. Please try again.</p>
                  <button onclick="loadLeaderboardData()"
                          style="background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-top: 10px;">üîÑ Retry</button>
                </div>
              `;
            }
            if (window.FPLUIManager && typeof FPLUIManager.updateQAPanel === 'function') {
              FPLUIManager.updateQAPanel();
            }
          });
      }

      // Display leaderboard with pagination
      function displayLeaderboard() {
        const container = document.getElementById('leaderboard-container');
        const navigation = document.querySelector('.leaderboard-navigation');

        if (!container) {
          console.error('Leaderboard container not found');
          return;
        }

        // Use window.leaderboardData if available (set by modular system), otherwise use local leaderboardData
        const dataToUse =
          window.leaderboardData && window.leaderboardData.length > 0
            ? window.leaderboardData
            : leaderboardData;
        console.log(
          'üìä displayLeaderboard() using data:',
          dataToUse ? dataToUse.length : 'no data',
          'players'
        );
        console.log(
          'üìä Data source:',
          window.leaderboardData ? 'window.leaderboardData' : 'local leaderboardData'
        );

        if (!dataToUse || dataToUse.length === 0) {
          container.innerHTML =
            '<div class="leaderboard-loading">No league standings available yet.</div>';
          return;
        }

        // Calculate pagination
        const totalPages = Math.ceil(dataToUse.length / leaderboardItemsPerPage);
        const startIndex = (currentLeaderboardPage - 1) * leaderboardItemsPerPage;
        const endIndex = startIndex + leaderboardItemsPerPage;
        const currentPageData = dataToUse.slice(startIndex, endIndex);

        // Generate table HTML

        const tableHTML = `
          <div class="leaderboard">
            <table class="leaderboard-table table-density-compact leaderboard__table leaderboard__table--compact">
              <colgroup>
                <col style="width:2ch">   <!-- Rank -->
                <col style="width:180px"> <!-- Player Name -->
                <col style="width:2ch">   <!-- Current GW -->
                <col style="width:3ch">   <!-- Total Points -->
                <col style="width:3ch">   <!-- FROM #1 -->
              </colgroup>
              <thead class="leaderboard__header">
                <tr class="leaderboard__row">
                  <th scope="col" class="col-rank leaderboard__cell leaderboard__cell--rank u-u-text-center" aria-label="Rank" data-short="#">#</th>
                  <th scope="col" class="leaderboard__cell leaderboard__cell--player u-text-left" aria-label="Player Name" title="Player Name">PLAYER</th>
                  <th scope="col" class="leaderboard__cell leaderboard__cell--gw u-text-right" aria-label="Current Gameweek Points" title="Current Gameweek Points">GW</th>
                  <th scope="col" class="leaderboard__cell leaderboard__cell--total u-text-right" aria-label="Total Points" title="Total Points">TOTAL</th>
                  <th scope="col" class="leaderboard__cell leaderboard__cell--deficit u-text-right" aria-label="Points Behind Leader" title="Points Behind Leader">FROM #1</th>
                </tr>
              </thead>
              <tbody class="leaderboard__body">
              ${currentPageData
                .map((player, index) => {
                  const actualRank = player.highlights.overallRank;

                  // Overall score field may be named differently depending on data source.
                  const rawScore =
                    (player.highlights && player.highlights.totalPoints) ||
                    (typeof player.totalPoints !== 'undefined' ? player.totalPoints : null);
                  const overallScore = rawScore === null ? null : Number(rawScore);
                  const scoreDisplay =
                    overallScore === null || isNaN(overallScore)
                      ? '‚Äî'
                      : overallScore.toLocaleString('en-IN');

                  // Enhanced data: Movement indicators
                  const movementIcon = player.movement?.icon || '';
                  const movementClass = player.movement?.direction
                    ? `movement-${player.movement.direction}`
                    : '';

                  // Enhanced data: Current GW points
                  const currentGWPoints =
                    player.highlights?.currentGWPoints || player.currentGWPoints || null;
                  const gwDisplay =
                    currentGWPoints && currentGWPoints > 0 ? currentGWPoints.toString() : '‚Äî';

                  // Enhanced data: Deficit from leader
                  const deficitValue =
                    player.highlights?.deficitFromLeader ?? player.deficitFromLeader ?? null;
                  const deficitDisplay =
                    deficitValue === 0
                      ? '‚Äî'
                      : deficitValue && deficitValue > 0
                        ? deficitValue.toString()
                        : '‚Äî';

                  return `
                <tr class="leaderboard__row${actualRank <= 3 ? ' leaderboard__row--winner' : ''}">
                  <td class="leaderboard-rank col-rank leaderboard__cell leaderboard__cell--rank u-u-text-center${
                    actualRank === 1
                      ? ' rank-1'
                      : actualRank === 2
                        ? ' rank-2'
                        : actualRank === 3
                          ? ' rank-3'
                          : ''
                  }">
                    <span class="rank-number">${actualRank}</span><span class="rank-movement ${movementClass}">${movementIcon}</span>
                  </td>
                  <td class="leaderboard-player leaderboard__cell leaderboard__cell--player u-text-left" title="${escapeHTML(player.playerName)}" aria-label="${escapeHTML(player.playerName)}">
                    <div class="player-team">${escapeHTML(player.playerName)}</div>
                  </td>
                  <td class="leaderboard-gw leaderboard__cell leaderboard__cell--gw u-text-right">${gwDisplay}</td>
                  <td class="leaderboard-total leaderboard__cell leaderboard__cell--total u-text-right">${scoreDisplay}</td>
                  <td class="leaderboard-deficit leaderboard__cell leaderboard__cell--deficit u-text-right">${deficitDisplay}</td>
                </tr>
              `;
                })
                .join('')}
            </tbody>
          </table>
        </div>
        `;

        container.innerHTML = '<div class="table-scroll">' + tableHTML + '</div>';

        // Show/hide navigation if needed
        if (navigation) {
          if (totalPages > 1) {
            FPLUtils.show(navigation);
            updateLeaderboardNavigation(totalPages);
          } else {
            FPLUtils.hide(navigation);
          }
        }
      }

      // Update navigation buttons and page info
      function updateLeaderboardNavigation(totalPages) {
        const prevBtn = document.getElementById('leaderboard-prev-page');
        const nextBtn = document.getElementById('leaderboard-next-page');
        const pageInfo = document.getElementById('leaderboard-page-info');

        if (prevBtn) prevBtn.disabled = currentLeaderboardPage === 1;
        if (nextBtn) nextBtn.disabled = currentLeaderboardPage === totalPages;
        if (pageInfo) pageInfo.textContent = `${currentLeaderboardPage} / ${totalPages}`;
      }

      // Pagination functions
      function previousLeaderboardPage() {
        if (currentLeaderboardPage > 1) {
          currentLeaderboardPage--;
          displayLeaderboard();
        }
      }

      function nextLeaderboardPage() {
        const dataToUse =
          window.leaderboardData && window.leaderboardData.length > 0
            ? window.leaderboardData
            : leaderboardData;
        const totalPages = Math.ceil(dataToUse.length / leaderboardItemsPerPage);
        if (currentLeaderboardPage < totalPages) {
          currentLeaderboardPage++;
          displayLeaderboard();
        }
      }

      // Expose functions to window immediately after definition for modular access
      window.leaderboardData = leaderboardData;
      window.loadLeaderboardData = loadLeaderboardData;
      window.displayLeaderboard = displayLeaderboard;
      window.nextLeaderboardPage = nextLeaderboardPage;
      window.previousLeaderboardPage = previousLeaderboardPage;

      // Prize function is defined earlier, expose it here too
      window.loadPrizeSummary = loadPrizeSummary;

      window.addEventListener('load', adjustForZFold);
      window.addEventListener('resize', debouncedAdjustForZFold);

      // Remove duplicate loadPrizeSummary - the correct one is already defined above
    </script>
    <!-- Rules modal wiring -->
    <script>
      (function () {
        function qs(id) {
          return document.getElementById(id);
        }
        function openModal() {
          var overlay = qs('rules-modal');
          var btn = qs('rules-btn');
          if (!overlay) return;
          overlay.classList.remove('is-hidden');
          if (btn) btn.setAttribute('aria-expanded', 'true');
          // focus modal close for keyboard users
          var closeBtn = overlay.querySelector('.modal-close');
          if (closeBtn) closeBtn.focus();
          document.addEventListener('keydown', onKey);
          overlay.addEventListener('click', onBackdrop, { once: true });
        }
        function closeModal() {
          var overlay = qs('rules-modal');
          var btn = qs('rules-btn');
          if (!overlay) return;
          overlay.classList.add('is-hidden');
          if (btn) btn.setAttribute('aria-expanded', 'false');
          document.removeEventListener('keydown', onKey);
        }
        function onKey(e) {
          if (e.key === 'Escape') closeModal();
        }
        function onBackdrop(e) {
          if (e.target && e.target.id === 'rules-modal') closeModal();
        }

        document.addEventListener('DOMContentLoaded', function () {
          var btn = qs('rules-btn');
          var overlay = qs('rules-modal');
          if (btn && overlay) btn.addEventListener('click', openModal);
          overlay &&
            overlay.querySelectorAll('.modal-close').forEach(function (el) {
              el.addEventListener('click', closeModal);
            });
        });
      })();
    </script>
    <!-- Twemoji for stat-box icons -->
    <script defer src="assets/twemoji/twemoji.min.js"></script>
    <script>
      window.applyTwemoji = function (root) {
        try {
          if (window.twemoji && typeof window.twemoji.parse === 'function') {
            window.twemoji.parse(root || document.body, {
              base: 'assets/twemoji/',
              folder: 'svg',
              ext: '.svg',
            });
          }
        } catch (e) {}
      };
      document.addEventListener('DOMContentLoaded', function () {
        if (!window.twemoji) {
          var s = document.createElement('script');
          s.src = 'https://twemoji.maxcdn.com/v/latest/twemoji.min.js';
          s.crossOrigin = 'anonymous';
          s.onload = function () {
            window.applyTwemoji(document.body);
          };
          document.head.appendChild(s);
        } else {
          window.applyTwemoji(document.body);
        }
      });
    </script>
  </body>
</html>
