<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JavaScript Functions Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 1000px;
        margin: 0 auto;
        line-height: 1.6;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }
      .warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }
      .info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
      }
      .test-result {
        margin: 10px 0;
        padding: 8px 12px;
        border-radius: 4px;
        font-family: monospace;
      }
      .button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      .button:hover {
        background: #0056b3;
      }
      pre {
        background: #f1f3f4;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
      }
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .status-pass {
        background-color: #28a745;
      }
      .status-fail {
        background-color: #dc3545;
      }
      .status-warn {
        background-color: #ffc107;
      }
    </style>
  </head>
  <body>
    <h1>JavaScript Functions Test Suite</h1>
    <p>
      This page tests the implementation of missing JavaScript functions and error prevention
      measures.
    </p>

    <div class="test-section info">
      <h2>Test Control Panel</h2>
      <button class="button" onclick="runAllTests()">üß™ Run All Tests</button>
      <button class="button" onclick="testFunctionSafety()">üîí Test Function Safety</button>
      <button class="button" onclick="testModuleLoading()">üì¶ Test Module Loading</button>
      <button class="button" onclick="clearResults()">üßπ Clear Results</button>
    </div>

    <div class="test-section" id="module-status">
      <h2>Module Availability</h2>
      <div id="module-results">Click "Test Module Loading" to check module availability.</div>
    </div>

    <div class="test-section" id="function-tests">
      <h2>Function Implementation Tests</h2>
      <div id="function-results">Click "Run All Tests" to start function testing.</div>
    </div>

    <div class="test-section" id="safety-tests">
      <h2>Function Safety Tests</h2>
      <div id="safety-results">Click "Test Function Safety" to run safety checks.</div>
    </div>

    <div class="test-section" id="error-simulation">
      <h2>Error Simulation</h2>
      <p>Test how the system handles missing modules and undefined functions.</p>
      <button class="button" onclick="simulateModuleMissing()">‚ö†Ô∏è Simulate Missing Module</button>
      <button class="button" onclick="simulateUndefinedFunction()">
        ‚ùå Simulate Undefined Function
      </button>
      <div id="error-results"></div>
    </div>

    <div class="test-section" id="console-output">
      <h2>Console Output</h2>
      <button class="button" onclick="showConsoleOutput()">üìä Show Console Messages</button>
      <pre id="console-log"></pre>
    </div>

    <!-- Include all the JavaScript modules -->
    <script src="js/error-handler.js?v=test"></script>
    <script src="js/utils.js?v=test"></script>
    <script src="js/data-loader.js?v=test"></script>
    <script src="js/ui-manager.js?v=test"></script>
    <script src="js/countdown.js?v=test"></script>

    <script>
      // Test results storage
      const testResults = {
        moduleAvailability: [],
        functionTests: [],
        safetyTests: [],
        errorTests: [],
      };

      // Console capture
      const consoleMessages = [];
      const originalConsole = {
        log: console.log,
        warn: console.warn,
        error: console.error,
        info: console.info,
        debug: console.debug,
      };

      // Capture console messages
      ['log', 'warn', 'error', 'info', 'debug'].forEach((method) => {
        console[method] = function (...args) {
          const message = args
            .map((arg) => (typeof arg === 'object' ? JSON.stringify(arg) : String(arg)))
            .join(' ');
          consoleMessages.push({
            type: method,
            message,
            time: new Date().toISOString(),
          });
          originalConsole[method].apply(console, args);
        };
      });

      // Test module loading
      function testModuleLoading() {
        console.info('üß™ Testing module availability...');

        const requiredModules = {
          FPLUtils: window.FPLUtils,
          FPLDataLoader: window.FPLDataLoader,
          FPLUIManager: window.FPLUIManager,
          FPLCountdown: window.FPLCountdown,
          ErrorHandler: window.ErrorHandler,
        };

        testResults.moduleAvailability = [];
        let html = '<h3>Module Loading Status</h3>';

        Object.entries(requiredModules).forEach(([name, module]) => {
          const isAvailable = module && typeof module === 'object';
          const status = isAvailable ? 'pass' : 'fail';
          const statusText = isAvailable ? '‚úÖ Available' : '‚ùå Missing';

          testResults.moduleAvailability.push({ name, available: isAvailable });

          html += `
          <div class="test-result ${isAvailable ? 'success' : 'error'}">
            <span class="status-indicator status-${status}"></span>
            <strong>${name}</strong>: ${statusText}
            ${isAvailable ? `(${Object.keys(module).length} methods)` : ''}
          </div>
        `;
        });

        document.getElementById('module-results').innerHTML = html;
        console.info('‚úÖ Module availability test completed');
      }

      // Test function implementations
      function testFunctionImplementations() {
        console.info('üß™ Testing function implementations...');

        testResults.functionTests = [];
        let html = '<h3>Function Implementation Results</h3>';

        const functionTests = [
          {
            name: 'FPLDataLoader.loadWinnerPreview',
            test: () => {
              if (
                !window.FPLDataLoader ||
                typeof window.FPLDataLoader.loadWinnerPreview !== 'function'
              ) {
                throw new Error('Function not found');
              }

              // Mock fetch for testing
              const originalFetch = window.fetch;
              window.fetch = jest.fn().mockResolvedValue({
                ok: true,
                json: () =>
                  Promise.resolve({
                    winners: [],
                    summary: { completedGameweeks: 5 },
                    lastUpdated: new Date().toISOString(),
                  }),
              });

              const result = window.FPLDataLoader.loadWinnerPreview();

              // Restore fetch
              window.fetch = originalFetch;

              return result instanceof Promise;
            },
          },
          {
            name: 'FPLUIManager.updateQAPanel',
            test: () => {
              if (!window.FPLUIManager || typeof window.FPLUIManager.updateQAPanel !== 'function') {
                throw new Error('Function not found');
              }

              // Should not throw when called
              try {
                window.FPLUIManager.updateQAPanel();
                return true;
              } catch (e) {
                console.warn(
                  'updateQAPanel threw an error, but this is expected without QA panel DOM:',
                  e.message
                );
                return true; // This is expected behavior
              }
            },
          },
          {
            name: 'Safe function calling pattern',
            test: () => {
              // Test the safeCall function from index.html
              const safeCall = (obj, methodName, ...args) => {
                try {
                  if (obj && typeof obj[methodName] === 'function') {
                    return obj[methodName](...args);
                  }
                  return null;
                } catch (error) {
                  return null;
                }
              };

              // Test with existing function
              const testObj = { testMethod: () => 'success' };
              const result1 = safeCall(testObj, 'testMethod');

              // Test with non-existing function
              const result2 = safeCall(testObj, 'nonExistent');

              return result1 === 'success' && result2 === null;
            },
          },
        ];

        functionTests.forEach(({ name, test }) => {
          try {
            const result = test();
            const passed = !!result;

            testResults.functionTests.push({ name, passed, error: null });

            html += `
            <div class="test-result ${passed ? 'success' : 'error'}">
              <span class="status-indicator status-${passed ? 'pass' : 'fail'}"></span>
              <strong>${name}</strong>: ${passed ? '‚úÖ Pass' : '‚ùå Fail'}
            </div>
          `;
          } catch (error) {
            testResults.functionTests.push({ name, passed: false, error: error.message });

            html += `
            <div class="test-result error">
              <span class="status-indicator status-fail"></span>
              <strong>${name}</strong>: ‚ùå Error - ${error.message}
            </div>
          `;
          }
        });

        document.getElementById('function-results').innerHTML = html;
        console.info('‚úÖ Function implementation tests completed');
      }

      // Test function safety mechanisms
      function testFunctionSafety() {
        console.info('üß™ Testing function safety mechanisms...');

        testResults.safetyTests = [];
        let html = '<h3>Function Safety Results</h3>';

        const safetyTests = [
          {
            name: 'Undefined function calls handled gracefully',
            test: () => {
              let errorThrown = false;
              try {
                // This should not throw a ReferenceError
                if (typeof nonExistentFunction !== 'undefined') {
                  nonExistentFunction();
                }
                return true;
              } catch (e) {
                if (e instanceof ReferenceError) {
                  errorThrown = true;
                }
                return false;
              }
            },
          },
          {
            name: 'Module existence checks work',
            test: () => {
              // Test the pattern used in index.html
              if (window.FPLUIManager && typeof FPLUIManager.updateQAPanel === 'function') {
                return true; // Function exists
              } else {
                return true; // Gracefully handled missing function
              }
            },
          },
          {
            name: 'Safe call wrapper prevents errors',
            test: () => {
              const safeCall = (obj, methodName, ...args) => {
                try {
                  if (obj && typeof obj[methodName] === 'function') {
                    return obj[methodName](...args);
                  }
                  return null;
                } catch (error) {
                  return null;
                }
              };

              // This should not throw even with completely invalid inputs
              const result1 = safeCall(null, 'someMethod');
              const result2 = safeCall(undefined, 'someMethod');
              const result3 = safeCall({}, 'nonExistentMethod');

              return result1 === null && result2 === null && result3 === null;
            },
          },
        ];

        safetyTests.forEach(({ name, test }) => {
          try {
            const passed = test();

            testResults.safetyTests.push({ name, passed, error: null });

            html += `
            <div class="test-result ${passed ? 'success' : 'warning'}">
              <span class="status-indicator status-${passed ? 'pass' : 'warn'}"></span>
              <strong>${name}</strong>: ${passed ? '‚úÖ Pass' : '‚ö†Ô∏è Warning'}
            </div>
          `;
          } catch (error) {
            testResults.safetyTests.push({ name, passed: false, error: error.message });

            html += `
            <div class="test-result error">
              <span class="status-indicator status-fail"></span>
              <strong>${name}</strong>: ‚ùå Error - ${error.message}
            </div>
          `;
          }
        });

        document.getElementById('safety-results').innerHTML = html;
        console.info('‚úÖ Function safety tests completed');
      }

      // Simulate missing module scenario
      function simulateModuleMissing() {
        console.warn('üß™ Simulating missing module scenario...');

        // Temporarily hide a module
        const originalUIManager = window.FPLUIManager;
        delete window.FPLUIManager;

        let html = '<h3>Missing Module Simulation</h3>';

        // Try to call functions that should be safely handled
        try {
          if (window.FPLUIManager && typeof window.FPLUIManager.updateQAPanel === 'function') {
            window.FPLUIManager.updateQAPanel();
            html +=
              '<div class="test-result error">‚ùå Should not have executed missing function</div>';
          } else {
            html +=
              '<div class="test-result success">‚úÖ Missing module correctly detected and handled</div>';
          }
        } catch (error) {
          html += `<div class="test-result error">‚ùå Error not handled: ${error.message}</div>`;
        }

        // Restore module
        window.FPLUIManager = originalUIManager;
        html += '<div class="test-result info">‚ÑπÔ∏è Module restored</div>';

        document.getElementById('error-results').innerHTML = html;
        console.info('‚úÖ Missing module simulation completed');
      }

      // Simulate undefined function call
      function simulateUndefinedFunction() {
        console.warn('üß™ Simulating undefined function call...');

        let html = '<h3>Undefined Function Simulation</h3>';

        try {
          // This should be safely handled
          if (typeof updateQAPanel !== 'undefined') {
            updateQAPanel();
            html +=
              '<div class="test-result error">‚ùå Should not have executed undefined function</div>';
          } else {
            html +=
              '<div class="test-result success">‚úÖ Undefined function correctly detected and ignored</div>';
          }

          // Test the safe calling pattern
          const safeCall = (obj, methodName, ...args) => {
            if (obj && typeof obj[methodName] === 'function') {
              return obj[methodName](...args);
            }
            console.warn(`Function ${methodName} not available`);
            return null;
          };

          const result = safeCall(window, 'nonExistentGlobalFunction');
          if (result === null) {
            html += '<div class="test-result success">‚úÖ Safe call pattern working correctly</div>';
          }
        } catch (error) {
          html += `<div class="test-result error">‚ùå Undefined function error not handled: ${error.message}</div>`;
        }

        document.getElementById('error-results').innerHTML = html;
        console.info('‚úÖ Undefined function simulation completed');
      }

      // Show console output
      function showConsoleOutput() {
        const output = consoleMessages
          .slice(-50) // Show last 50 messages
          .map(
            (msg) =>
              `[${new Date(msg.time).toLocaleTimeString()}] ${msg.type.toUpperCase()}: ${msg.message}`
          )
          .join('\n');

        document.getElementById('console-log').textContent =
          output || 'No console messages captured.';
      }

      // Clear all results
      function clearResults() {
        document.getElementById('module-results').innerHTML =
          'Click "Test Module Loading" to check module availability.';
        document.getElementById('function-results').innerHTML =
          'Click "Run All Tests" to start function testing.';
        document.getElementById('safety-results').innerHTML =
          'Click "Test Function Safety" to run safety checks.';
        document.getElementById('error-results').innerHTML = '';
        document.getElementById('console-log').textContent = '';

        // Clear test results
        Object.keys(testResults).forEach((key) => {
          testResults[key] = [];
        });

        console.info('‚úÖ Test results cleared');
      }

      // Run all tests
      function runAllTests() {
        console.info('üöÄ Running complete test suite...');

        setTimeout(() => testModuleLoading(), 100);
        setTimeout(() => testFunctionImplementations(), 200);
        setTimeout(() => testFunctionSafety(), 300);

        console.info('‚úÖ All tests queued for execution');
      }

      // Auto-run tests on page load
      window.addEventListener('load', () => {
        console.info('üß™ JavaScript Functions Test Suite loaded');
        console.info('Use the control panel to run tests');
      });

      // Export test functions for manual use
      window.testJSFunctions = {
        runAllTests,
        testModuleLoading,
        testFunctionImplementations,
        testFunctionSafety,
        simulateModuleMissing,
        simulateUndefinedFunction,
        showConsoleOutput,
        clearResults,
        getTestResults: () => testResults,
      };
    </script>
  </body>
</html>
