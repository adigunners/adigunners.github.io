<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Complete Winner Scorecard - IIM Mumbai Fantasy League</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <style>
      :root {
        --primary-color: #37003c;
        --secondary-color: #00ff85;
        --background-color: #f0f2f5;
        --card-background: #fff;
        --text-color: #333;
        --heading-color: #5d2163;
      }
      body {
        font-family: "Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Helvetica, Arial, sans-serif;
        line-height: 1.7;
        margin: 0;
        background-color: var(--background-color);
        color: var(--text-color);
      }
      .container {
        max-width: 1200px;
        margin: 20px auto;
        background-color: transparent;
      }
      header {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--heading-color)
        );
        color: #fff;
        text-align: center;
        padding: 40px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        margin-bottom: 30px;
      }
      header h1 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 700;
      }
      header p {
        margin: 5px 0 0;
        font-size: 1.1rem;
        opacity: 0.9;
      }
      .back-button {
        display: inline-block;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 5px;
        margin-top: 15px;
        transition: background 0.2s ease;
      }
      .back-button:hover {
        background: rgba(255, 255, 255, 0.3);
      }
      main {
        padding: 0;
      }
      section {
        background-color: var(--card-background);
        padding: 30px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      }
      h2 {
        color: var(--heading-color);
        border-bottom: 2px solid #f0f2f5;
        padding-bottom: 10px;
        margin-top: 0;
        font-size: 1.8rem;
      }
      .winner-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        font-variant-numeric: tabular-nums; /* Ensures consistent digit alignment */
      }
      
      .winner-table th {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--heading-color)
        );
        color: white;
        padding: 14px 16px;
        text-align: left;
        font-weight: 700;
        font-size: 0.95rem;
        letter-spacing: 0.3px;
        text-transform: uppercase;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      
      /* Specific alignment for table headers */
      .winner-table th:nth-child(1) {
        text-align: center; /* Rank column */
        width: 70px;
        min-width: 70px;
        max-width: 70px;
      }
      
      .winner-table th:nth-child(2) {
        text-align: left; /* Player column */
        /* Dynamic width - will be set by JavaScript based on longest name */
        min-width: 120px;
      }
      
      .winner-table th:nth-child(3) {
        text-align: right; /* Total Prize Won column */
        width: 130px;
        min-width: 130px;
        max-width: 130px;
      }
      
      .winner-table th:nth-child(4) {
        text-align: right; /* Highlights column */
        /* Dynamic width - takes remaining space */
        min-width: 200px;
      }
      
      .winner-table td {
        padding: 14px 16px;
        border-bottom: 1px solid #f0f2f5;
        font-size: 0.9rem;
        transition: background-color 0.2s ease;
      }
      
      /* Zebra striping for better row scanning */
      .winner-table tbody tr:nth-child(even) {
        background-color: #f8f9fa;
      }
      
      .winner-table tbody tr:nth-child(odd) {
        background-color: white;
      }
      
      /* Enhanced hover state */
      .winner-table tbody tr:hover {
        background-color: #e3f2fd !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      /* Specific alignment for table data cells */
      .winner-table td:nth-child(1) {
        text-align: center; /* Rank column */
        font-weight: 600;
      }
      
      .winner-table td:nth-child(2) {
        text-align: left; /* Player column */
      }
      
      .winner-table td:nth-child(3) {
        text-align: right; /* Total Prize Won column */
        font-variant-numeric: tabular-nums;
        font-weight: 700;
      }
      
      .winner-table td:nth-child(4) {
        text-align: right; /* Highlights column */
      }
      
      .winner-table tr:last-child td {
        border-bottom: none;
      }
      .player-name {
        font-weight: 600;
        color: var(--heading-color);
      }
      .prize-amount {
        font-weight: 700;
        color: var(--primary-color);
        font-size: 1.1rem;
      }
      .highlights {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end; /* Right-align the badges */
      }
      .highlight-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: transform 0.2s ease;
      }
      
      .highlight-badge:hover {
        transform: translateY(-1px);
      }

      .highlight-badge.gw {
        background: var(--secondary-color);
        color: var(--primary-color);
      }
      
      .highlight-badge.gw::before {
        content: "üèÜ";
        font-size: 0.8em;
      }

      .highlight-badge.gm {
        background: #ff6b6b;
        color: white;
      }
      
      .highlight-badge.gm::before {
        content: "üìÖ";
        font-size: 0.8em;
      }
      
      .highlight-badge:not(.gw):not(.gm)::before {
        content: "üìä";
        font-size: 0.8em;
      }
      .winner-loading {
        text-align: center;
        padding: 40px;
        color: #777;
        font-style: italic;
      }
      .winner-loading:after {
        content: "";
        display: block;
        margin: 10px auto;
        width: 40px;
        height: 40px;
        border: 4px solid var(--primary-color);
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .winner-error {
        text-align: center;
        padding: 40px;
        color: #d32f2f;
        background: #ffebee;
        border-radius: 8px;
        margin-top: 20px;
      }
      .stats-summary {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
      }
      .summary-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        text-align: center;
        min-width: 150px;
      }
      .summary-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 5px;
      }
      .summary-label {
        color: #777;
        font-size: 0.9rem;
      }
      footer {
        text-align: center;
        font-size: 0.8rem;
        color: #888;
        padding: 20px;
      }

      @media (max-width: 800px) {
        .container {
          max-width: 98vw;
        }
        .stats-summary {
          gap: 15px;
        }
      }
      @media (max-width: 600px) {
        header h1 {
          font-size: 1.8rem;
        }
        section {
          padding: 20px;
        }
        h2 {
          font-size: 1.5rem;
        }
        .winner-table {
          font-size: 0.8rem;
        }
        .winner-table th,
        .winner-table td {
          padding: 10px 8px;
        }
        
        /* Mobile-specific column adjustments */
        .winner-table th:nth-child(1),
        .winner-table td:nth-child(1) {
          width: 50px !important;
          min-width: 50px !important;
          max-width: 50px !important;
        }
        
        .winner-table th:nth-child(3),
        .winner-table td:nth-child(3) {
          width: 100px !important;
          min-width: 100px !important;
          max-width: 100px !important;
          font-size: 0.75rem;
        }
        
        .highlights {
          gap: 4px;
          flex-direction: column;
          align-items: flex-end;
        }
        .highlight-badge {
          font-size: 0.65rem;
          padding: 2px 4px;
        }
        .stats-summary {
          flex-direction: column;
          align-items: center;
        }
        .summary-card {
          width: 100%;
          max-width: 200px;
        }
        
        /* Override dynamic styles on mobile for better fit */
        #dynamic-table-styles {
          display: none !important;
        }
      }
      
      /* Additional styles that were misplaced */
      .test-section {
        display: none;
        border: 2px dashed #ff6b6b;
        padding: 10px;
        margin: 20px;
        text-align: center;
        background: #fff5f5;
        border-radius: 8px;
        font-weight: 600;
        color: #ff6b6b;
      }
      
      .winner-last-updated {
        text-align: center;
        font-size: 0.93rem;
        color: #777;
        font-style: italic;
        margin-top: 20px;
      }
      
      .footer-last-updated {
        font-size: 0.7rem;
        color: #ccc;
        margin-top: 5px;
      }
      
      .winner-rank {
        font-weight: 600;
        color: var(--primary-color);
      }

      /* Gold, Silver, Bronze styling for top 3 ranks */
      .rank-1 {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        color: #8B4513;
        font-weight: 700;
        padding: 4px 8px;
        border-radius: 4px;
      }
      
      .rank-2 {
        background: linear-gradient(135deg, #C0C0C0, #808080);
        color: #2F4F4F;
        font-weight: 700;
        padding: 4px 8px;
        border-radius: 4px;
      }
      
      .rank-3 {
        background: linear-gradient(135deg, #CD7F32, #A0522D);
        color: #FFFFFF;
        font-weight: 700;
        padding: 4px 8px;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üèÜ Complete Winner Scorecard</h1>
        <p>IIM Mumbai Fantasy League - Season 2025-26</p>
        <a href="index.html" class="back-button">
          <i class="fas fa-arrow-left"></i> Back to Home
        </a>
      </header>
      <div class="test-section">üß™ Testing Mode Active</div>

      <main>
        <section>
          <h2>üìä League Statistics</h2>
          <div class="stats-summary" id="stats-summary">
            <div class="summary-card">
              <div class="summary-number" id="completed-gameweeks">--</div>
              <div class="summary-label">Completed Gameweeks</div>
            </div>
            <div class="summary-card">
              <div class="summary-number" id="total-winners">--</div>
              <div class="summary-label">Total Winners</div>
            </div>
            <div class="summary-card">
              <div class="summary-number" id="total-prize-money">--</div>
              <div class="summary-label">Total Prize Money</div>
            </div>
          </div>
        </section>

        <section>
          <h2>üèÖ Complete Winner Rankings</h2>
          <p>All players ranked by total prize money won this season.</p>

          <div id="winner-table-container">
            <div class="winner-loading">Loading complete winner data...</div>
          </div>

          <div id="winner-last-updated" class="winner-last-updated">
            Fetching latest winner data...
          </div>
        </section>
      </main>

      <footer>
        <p>&copy; 2025 IIM Mumbai Fantasy League Organising Committee</p>
        <p class="footer-last-updated">
          Last updated: August 2025
        </p>
      </footer>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        loadWinnerData();
        checkTestMode();
      });

      function loadWinnerData() {
        // Check if we're in test mode and load appropriate file
        const urlParams = new URLSearchParams(window.location.search);
        const isTestMode = urlParams.get("test") === "true";

        const winnerUrl = isTestMode
          ? "test_winner_stats.json?cache=" + new Date().getTime()
          : "winner_stats.json?cache=" + new Date().getTime();

        console.log(
          isTestMode
            ? "üß™ Loading TEST winner data"
            : "üìä Loading LIVE winner data"
        );

        fetch(winnerUrl)
          .then((response) => {
            console.log("Winner fetch response:", response);
            if (!response.ok) {
              throw new Error("Winner data fetch failed");
            }
            return response.json();
          })
          .then((data) => {
            console.log("Fetched winner data:", data);

            // Add test mode indicator if needed
            if (isTestMode && data.testMode) {
              const headerP = document.querySelector("header p");
              if (headerP && !headerP.textContent.includes("[TEST MODE]")) {
                headerP.textContent =
                  headerP.textContent + " [TEST MODE - Demo Data]";
                headerP.style.color = "#ff6b6b";
              }
            }

            displayWinnerTable(data.winners);
            updateStatsSummary(data.winners);
            
            // Update completed gameweeks from the JSON data summary
            if (data.summary && data.summary.completedGameweeks !== undefined) {
              document.getElementById("completed-gameweeks").textContent = data.summary.completedGameweeks;
            }

            // Show last updated time for winners
            const lastUpdated = new Date(data.lastUpdated);
            const userTimeZone =
              Intl.DateTimeFormat().resolvedOptions().timeZone;
            const userLocale = navigator.language || "en-GB";
            const formattedDate = lastUpdated.toLocaleString(userLocale, {
              dateStyle: "medium",
              timeStyle: "short",
              timeZone: userTimeZone,
            });

            const updateText = isTestMode
              ? `Last updated: ${formattedDate} (test data)`
              : `Last updated: ${formattedDate} (your local time)`;

            document.getElementById("winner-last-updated").textContent =
              updateText;
          })
          .catch((error) => {
            console.error("Winner fetch error:", error);
            document.getElementById("winner-table-container").innerHTML =
              '<div class="winner-error">Unable to load winner data. Please try again later.</div>';
          });
      }

      function displayWinnerTable(winners) {
        if (!winners || winners.length === 0) {
          document.getElementById("winner-table-container").innerHTML =
            '<div class="winner-loading">No winner data available yet.</div>';
          return;
        }

        // Sort winners by total prize won (descending)
        const sortedWinners = winners.sort(
          (a, b) => b.totalPrizeWon - a.totalPrizeWon
        );

        let tableHTML = '<table class="winner-table" id="dynamic-winner-table">';
        tableHTML += '<thead><tr><th>Rank</th><th>Player</th><th>Total Prize Won</th><th>Highlights</th></tr></thead>';
        tableHTML += '<tbody>';
        
        sortedWinners.forEach((winner, index) => {
          const rank = index + 1;
          const rankClass = index < 3 ? ` rank-${rank}` : '';
          const gameWeeksBadge = winner.highlights.gameWeeks > 0 
            ? `<span class="highlight-badge gw">${winner.highlights.gameWeeks}GW</span>` 
            : '';
          const gameMonthsBadge = winner.highlights.gameMonths > 0 
            ? `<span class="highlight-badge gm">${winner.highlights.gameMonths}GM</span>` 
            : '';
          const overallRankBadge = winner.highlights.overallRank 
            ? `<span class="highlight-badge">League Rank: ${winner.highlights.overallRank}</span>` 
            : '';
            
          tableHTML += `<tr>`;
          tableHTML += `<td class="winner-rank${rankClass}">${rank}</td>`;
          tableHTML += `<td class="player-name">${winner.playerName}</td>`;
          tableHTML += `<td class="prize-amount">‚Çπ${winner.totalPrizeWon.toLocaleString('en-IN')}</td>`;
          tableHTML += `<td><div class="highlights">${gameWeeksBadge}${gameMonthsBadge}${overallRankBadge}</div></td>`;
          tableHTML += `</tr>`;
        });
        
        tableHTML += '</tbody></table>';

        document.getElementById("winner-table-container").innerHTML = tableHTML;
        
        // Apply dynamic column widths after table is rendered
        setTimeout(() => {
          optimizeTableColumnWidths(sortedWinners);
        }, 50);
      }
      
      function optimizeTableColumnWidths(winners) {
        const table = document.getElementById('dynamic-winner-table');
        if (!table || !winners || winners.length === 0) return;
        
        console.log('üîß Optimizing table column widths...');
        
        // Create a temporary invisible element to measure text widths
        const measureEl = document.createElement('span');
        measureEl.style.visibility = 'hidden';
        measureEl.style.position = 'absolute';
        measureEl.style.whiteSpace = 'nowrap';
        measureEl.style.fontFamily = 'Poppins, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';
        measureEl.style.fontSize = '0.9rem';
        measureEl.style.fontWeight = '600';
        document.body.appendChild(measureEl);
        
        try {
          // Find the longest player name
          let maxPlayerNameWidth = 0;
          let longestName = 'Player'; // Default to header text
          
          winners.forEach(winner => {
            measureEl.textContent = winner.playerName;
            const width = measureEl.offsetWidth;
            if (width > maxPlayerNameWidth) {
              maxPlayerNameWidth = width;
              longestName = winner.playerName;
            }
          });
          
          // Also check header width
          measureEl.style.fontWeight = '700';
          measureEl.style.fontSize = '0.95rem';
          measureEl.style.letterSpacing = '0.3px';
          measureEl.textContent = 'PLAYER';
          const headerWidth = measureEl.offsetWidth;
          
          // Use the larger of content width or header width, plus padding
          const playerColumnWidth = Math.max(maxPlayerNameWidth, headerWidth) + 32; // 16px padding on each side
          
          console.log(`üìè Longest player name: "${longestName}" (${maxPlayerNameWidth}px)`);
          console.log(`üìè Header width: ${headerWidth}px`);
          console.log(`üìè Final player column width: ${playerColumnWidth}px`);
          
          // Apply the calculated width to player column
          // Use CSS custom properties for dynamic widths
          const styleElement = document.createElement('style');
          styleElement.innerHTML = `
            .winner-table th:nth-child(2),
            .winner-table td:nth-child(2) {
              width: ${playerColumnWidth}px;
              max-width: ${playerColumnWidth}px;
            }
          `;
          
          // Remove any existing dynamic styles
          const existingStyle = document.getElementById('dynamic-table-styles');
          if (existingStyle) {
            existingStyle.remove();
          }
          
          styleElement.id = 'dynamic-table-styles';
          document.head.appendChild(styleElement);
          
          console.log('‚úÖ Dynamic column widths applied successfully');
          
        } catch (error) {
          console.error('‚ùå Error optimizing column widths:', error);
        } finally {
          // Clean up measurement element
          document.body.removeChild(measureEl);
        }
      }

      function loadFPLData() {
        const fplApiUrl =
          "https://fantasy.premierleague.com/api/bootstrap-static/";

        fetch(fplApiUrl)
          .then((response) => {
            if (!response.ok) {
              throw new Error("FPL API fetch failed");
            }
            return response.json();
          })
          .then((data) => {
            // Count completed gameweeks (finished: true)
            const completedGameweeks = data.events.filter(
              (event) => event.finished === true
            ).length;
            document.getElementById("completed-gameweeks").textContent =
              completedGameweeks;
          })
          .catch((error) => {
            console.error("FPL API fetch error:", error);
            document.getElementById("completed-gameweeks").textContent = "--";
          });
      }

      function updateStatsSummary(winners) {
        if (!winners || winners.length === 0) return;

        const totalWinners = winners.length;
        const totalPrizeMoney = winners.reduce(
          (sum, winner) => sum + winner.totalPrizeWon,
          0
        );

        document.getElementById("total-winners").textContent = totalWinners;
        document.getElementById("total-prize-money").textContent =
          "‚Çπ" + totalPrizeMoney.toLocaleString("en-IN");
      }

      function checkTestMode() {
        const params = new URLSearchParams(window.location.search);
        if (params.get("test") === "true") {
          console.log("üß™ Test mode activated!");
          const section = document.querySelector(".test-section");
          if (section) section.style.display = "block";
        }
      }
    </script>
  </body>
</html>
